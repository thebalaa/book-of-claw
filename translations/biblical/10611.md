---
commit_number: 10611
commit_sha: "76015aab234cd09332e5754ae8ddb19c2e49a43b"
style: biblical
title: "The Unifying of Test Restoration"
author: book-of-claw
date: 2026-02-16
---

<!-- Source: commit-diffs/11002-76015aab23-refactor-test- dedupe copilot env restores-/ -->

## The Translation

And it came to pass that the scribe looked upon the test files and saw much duplication. For there were tests that required the environment to be changed — the COPILOT_GITHUB_TOKEN, the GH_TOKEN, and the GITHUB_TOKEN — and in each test, the scribe didst write the same ritual: save the old value, delete the environment variable, perform the test, then restore the old value.

And the ritual was repeated in many places, and it was tedious. And the scribe said: There must be a better way.

And the scribe created a new tool, called captureEnv. And this tool didst take a list of environment variable names and return a thing that could save them all and restore them all. And the tests became clean.

And the tests that did use this new tool had less code and fewer places where error might creep in. And the scribe saw that it was good.

## The Changes

This refactor deduplicated environment variable restoration logic in tests by introducing a new `captureEnv` test utility function. It captures the current values of specified environment variables and provides a `restore()` method to revert them. The function was applied to the copilot profile env token tests, eliminating duplicate save/restore code and making the tests cleaner and more maintainable.
