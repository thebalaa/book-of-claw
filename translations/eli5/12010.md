---
commit_number: 12010
commit_sha: "52b624ccae8921608004d586dd7183e529897786"
style: eli5
title: "The Doctor Learns to Check Both Places for the Secret Key"
author: balaa
date: 2026-02-16
---

<!-- Source: commit-diffs/12010-52b624ccae-fix-doctor- audit env-only gateway tokens-/ -->

## The Translation

Imagine your house has a lock, and the key can be stored in one of two places: either in a special locked box (a settings file), or written on a sticky note on the fridge (an environment variable â€” a box that holds a value the computer can look up by name). The "doctor" is a tool that checks if your setup is healthy and fixes problems it finds. Before this fix, the doctor only knew to look for the key in the locked box. If the key was only on the fridge sticky note, the doctor would get confused.

Sebastian fixed this. He taught the doctor to look in both places. First it checks the settings file. If there's nothing there, it checks the fridge sticky note (the `OPENCLAW_GATEWAY_TOKEN` environment variable). Now, whichever place you keep your key, the doctor finds it and uses it correctly when checking and repairing the gateway (the door between the program and the outside world).

He also added a new check (a test) to make sure this works: the test pretends the settings file has no token but the sticky note does, and confirms the doctor picks up the right key from the right place.

## The Changes

- Added a new helper function `resolveGatewayAuthToken` in `src/commands/doctor-gateway-services.ts` that looks for the gateway token first in the config file (`cfg.gateway?.auth?.token`) and then falls back to the `OPENCLAW_GATEWAY_TOKEN` or `CLAWDBOT_GATEWAY_TOKEN` environment variables.
- Updated `maybeRepairGatewayServiceConfig` to use this new function when both auditing and building the repair plan, replacing two separate direct lookups that could give different answers.
- Added a new test case in `src/commands/doctor-gateway-services.test.ts` covering the case where the config token is missing but `OPENCLAW_GATEWAY_TOKEN` is set in the environment.
- Added a `beforeEach(() => vi.clearAllMocks())` cleanup to keep tests from interfering with each other.
- Updated `CHANGELOG.md` with a note about heartbeat sender metadata.
