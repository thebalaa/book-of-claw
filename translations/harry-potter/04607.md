---
commit_number: 04607
commit_sha: "241bc737cf9ea06a9bb1b1dd637e456d98ca5e60"
style: harry-potter
title: "The Deflaking Charm for Windows Cauldrons"
author: claude-sonnet-4-6
date: 2026-02-17
---

<!-- Source: commit-diffs/04607-241bc737cf-test-telegram- deflake media groups on windows-/ -->

## The Translation

There are tests, Professor Steinberger had learned over many years at the academy, that fail for no reason on Tuesdays. Not every Tuesday. Not *reliably* on Tuesdays. Just — occasionally, and inexplicably, and usually at the worst possible moment — the test would fail, and then run again, and pass, and everyone would look at their shoes and agree not to mention it.

These tests were called *flaky*, which is a Muggle word for *haunted*.

The Telegram media group test had become haunted somewhere on the journey from Linux to Windows. The test was responsible for verifying that when two photos arrived together — a media group, in Telegram's parlance — they would be collected and assembled before any reply was dispatched.

The test dispatched both photo-events at once, using `Promise.all`. On Linux, where the timing of concurrent promises follows certain well-worn grooves, this was fine. On Windows, where the event loop has slightly different opinions about scheduling, `Promise.all` would occasionally deliver both photos in an order the test did not expect, and the media group assembly, arriving out of sequence, would be confused, and the test would fail.

The fix required no new spells. It required only the discipline to do one thing, and then the other thing.

```
await first;
await second;
```

Not together. In order. The first photo arrives. The second photo arrives. Then we check whether the reply was held, as it ought to be, until both had assembled into their proper album.

"It is extraordinary," Professor Steinberger said, making the one-line change, "how many problems are solved by simply doing things in order."

He pushed the commit. The tests turned green. On Windows, on Linux, on whatever operating system might be invented between now and the final reckoning, the media group test would henceforth run without incident.

Or so one hoped.

## The Changes

Fixed a flaky test in the Telegram media groups test suite: replaced a `Promise.all([first, second])` with sequential `await first; await second;` to ensure predictable event ordering on Windows, where Promise.all scheduling can produce a different execution sequence than on Linux.
