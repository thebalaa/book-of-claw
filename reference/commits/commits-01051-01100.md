# Commit Reference: 01051–01100

A plain factual summary of every commit in the OpenClaw repository, from commit 1051 through commit 1100.

---

## 01051 — mac: drop yarn fallback
**SHA:** 84499ab969 · **Date:** 2025-12-10 03:49
**Files changed:** `apps/macos/Sources/Clawdis/ToolsSettings.swift`
**Tags:** `refactor`

Removed yarn fallback logic that mapped legacy yarn selection to Bun. The package manager selection now directly returns npm if the configured value is invalid, simplifying backwards compatibility handling.

---

## 01052 — test: add gateway/runtime utility coverage
**SHA:** efde37eb36 · **Date:** 2025-12-10 01:19
**Files changed:** `apps/macos/Tests/ClawdisIPCTests/GatewayEnvironmentTests.swift`, `apps/macos/Tests/ClawdisIPCTests/RuntimeLocatorTests.swift`, `apps/macos/Tests/ClawdisIPCTests/UtilitiesTests.swift`
**Tags:** `testing`

Added comprehensive test coverage for gateway runtime utilities including Semver parsing, gateway port configuration, runtime resolution with version validation, and error handling for various failure scenarios.

---

## 01053 — test: add semver and gateway helpers coverage
**SHA:** 00ace3bb63 · **Date:** 2025-12-10 01:26
**Files changed:** `apps/macos/Sources/Clawdis/GatewayEnvironment.swift`, `apps/macos/Tests/ClawdisIPCTests/GatewayEnvironmentTests.swift`, `apps/macos/Tests/ClawdisIPCTests/SemverTests.swift`, `apps/macos/Tests/ClawdisIPCTests/UtilitiesTests.swift`
**Tags:** `testing`, `core-feature`

Extended testing to cover Semver comparison logic, gateway version expectations, and utility functions for entrypoint location and log file discovery, with full path validation.

---

## 01054 — webchat: show real ws errors
**SHA:** 49e70746f0 · **Date:** 2025-12-10 01:27
**Files changed:** `apps/macos/Sources/Clawdis/Resources/WebChat/bootstrap.js`, `apps/macos/Sources/Clawdis/Resources/WebChat/format-error.js`, `apps/macos/Sources/Clawdis/Resources/WebChat/webchat.bundle.js`, `test/format-error.test.ts`, `vitest.config.ts`
**Tags:** `error-handling`, `ui`

Introduced a WebSocket error formatter that displays actionable error messages, distinguishing between CloseEvent, WebSocket error events, and generic errors with proper state labels and reasoning details.

---

## 01055 — fix: persist usage from rpc
**SHA:** c4b02645f5 · **Date:** 2025-12-10 01:37
**Files changed:** `src/agents/agents.test.ts`, `src/agents/pi.ts`, `src/auto-reply/command-reply.ts`
**Tags:** `bugfix`, `persistence`

Fixed issue where agent metadata and usage stats were lost when assistant messages contained no text. Now the parsing logic always records the last assistant message to preserve model, provider, and usage information.

---

## 01056 — mac: add attach-only gateway toggle
**SHA:** cce65e19e1 · **Date:** 2025-12-10 11:31
**Files changed:** `apps/macos/Sources/Clawdis/AppState.swift`, `apps/macos/Sources/Clawdis/Constants.swift`, `apps/macos/Sources/Clawdis/DebugSettings.swift`, `apps/macos/Sources/Clawdis/GatewayProcessManager.swift`, `apps/macos/Sources/Clawdis/Utilities.swift`
**Tags:** `feature`, `config`

Added debug toggle to allow the macOS app to attach only to an existing gateway without spawning a local one. Useful for testing scenarios where gateway control needs to be isolated from the mac app's lifecycle.

---

## 01057 — pi: parse turn_end streams
**SHA:** 81385cf820 · **Date:** 2025-12-10 11:31
**Files changed:** `src/agents/pi.ts`
**Tags:** `core-feature`, `api`

Enhanced pi agent JSON parsing to handle turn_end event streams with proper assistant message and tool result extraction, supporting more granular streaming protocol events.

---

## 01058 — RPC: handle tau auto-compaction retries
**SHA:** 8f37f15a33 · **Date:** 2025-12-10 11:40
**Files changed:** `src/process/tau-rpc.ts`
**Tags:** `error-handling`, `process-lifecycle`

Implemented retry logic for tau RPC auto-compaction events, with state tracking for compaction runs and pending retries. Added resolution timing window to allow compaction events to arrive after agent_end.

---

## 01059 — RPC: auto-cancel hook UI prompts
**SHA:** 53c349cb86 · **Date:** 2025-12-10 11:46
**Files changed:** `src/process/tau-rpc.ts`
**Tags:** `bugfix`, `error-handling`

Added automatic cancellation of hook_ui_request events in non-interactive surfaces like WhatsApp by sending a fire-and-forget response, preventing UI prompts from blocking the agent.

---

## 01060 — mac: include instance id in presence beacons
**SHA:** fe3a983d35 · **Date:** 2025-12-10 11:48
**Files changed:** `apps/macos/Sources/Clawdis/ControlChannel.swift`, `apps/macos/Sources/Clawdis/PresenceReporter.swift`
**Tags:** `feature`, `analytics`

Extended system event presence reporting to include instance ID, host, IP, mode, version, and last input seconds. This provides richer telemetry for gateway presence tracking and observability.

---

## 01061 — gateway: dedupe system-event presence
**SHA:** df4331da04 · **Date:** 2025-12-10 11:48
**Files changed:** `src/gateway/server.ts`
**Tags:** `bugfix`, `core-feature`

Modified gateway system-event handling to extract and validate presence parameters (instanceId, host, ip, mode, version, reason, tags) before updating presence, preventing duplicate or malformed entries.

---

## 01062 — Auto-reply: reject empty inbound messages
**SHA:** 5e4a91f996 · **Date:** 2025-12-10 13:51
**Files changed:** `src/auto-reply/reply.ts`
**Tags:** `bugfix`, `error-handling`

Added early validation to reject empty inbound message bodies after normalization, returning a user-friendly message instead of sending empty prompts to the agent.

---

## 01063 — fix(pi): skip -p when running rpc
**SHA:** fd3516bc82 · **Date:** 2025-12-10 14:21
**Files changed:** `src/agents/pi.ts`
**Tags:** `bugfix`, `api`

Fixed issue where the -p (print) flag was being incorrectly added when running pi in rpc mode. RPC mode has its own output handling, so the flag is now skipped for rpc.

---

## 01064 — fix(auto-reply): guard empty rpc prompt
**SHA:** b61147aed0 · **Date:** 2025-12-10 14:26
**Files changed:** `src/auto-reply/command-reply.ts`
**Tags:** `bugfix`, `api`

Added fallback to default body when rpc prompt argument is empty, with verbose logging for debugging. If no prompt is extracted, the command falls back to the original body text.

---

## 01065 — mac: surface gateway auth failures
**SHA:** 063b35f1dc · **Date:** 2025-12-10 14:32
**Files changed:** `apps/macos/Sources/Clawdis/ControlChannel.swift`, `apps/macos/Sources/Clawdis/GatewayChannel.swift`
**Tags:** `bugfix`, `error-handling`

Enhanced error reporting for gateway authentication failures by detecting URLError with dataNotAllowed code (WS close 1008) and surfacing token mismatch errors with actionable guidance.

---

## 01066 — telegram: fix verbose log ordering
**SHA:** f6a86e5527 · **Date:** 2025-12-10 14:33
**Files changed:** `src/telegram/bot.ts`
**Tags:** `logging`, `bugfix`

Added verbose logging for inbound Telegram messages showing chatId, sender, message length, and preview. Logging now occurs before reply processing for better debugging of message flow.

---

## 01067 — fix(auto-reply): fall back to json when rpc prompt empty
**SHA:** 4db69c8eac · **Date:** 2025-12-10 14:58
**Files changed:** `src/auto-reply/command-reply.ts`
**Tags:** `bugfix`, `api`

Introduced fallback behavior when RPC mode produces empty user text in the output. The system now attempts to retry with JSON mode to handle edge cases where RPC output is malformed.

---

## 01068 — webchat: improve logging and static serving
**SHA:** 3796882d22 · **Date:** 2025-12-10 15:32
**Files changed:** `apps/macos/Sources/Clawdis/Resources/WebChat/bootstrap.js`, `apps/macos/Sources/Clawdis/Resources/WebChat/webchat.bundle.js`
**Tags:** `logging`, `ui`

Enhanced WebChat bootstrap logging with detailed status messages for WebSocket connection lifecycle events (open, hello-ok, errors, close) and improved debugging output.

---

## 01069 — gateway: add webchat handshake logging
**SHA:** 6459582952 · **Date:** 2025-12-10 15:32
**Files changed:** `src/gateway/server.ts`
**Tags:** `logging`, `core-feature`

Added comprehensive logging for WebSocket handshake lifecycle including hello message description, presence snapshot details, and health status, improving observability of gateway connections.

---

## 01070 — fix(agent): send structured prompt to tau rpc
**SHA:** 8f456ea73b · **Date:** 2025-12-10 15:52
**Files changed:** `src/process/tau-rpc.ts`
**Tags:** `bugfix`, `api`

Changed tau RPC prompt format from raw string to structured content envelope with text type, improving compatibility with newer tau RPC builds and avoiding empty-text bugs.

---

## 01071 — fix(auto-reply): acknowledge reset triggers
**SHA:** 51d77aea2e · **Date:** 2025-12-10 15:55
**Files changed:** `src/auto-reply/reply.triggers.test.ts`, `src/auto-reply/reply.ts`
**Tags:** `bugfix`, `testing`

Added test case for bare /new trigger without treating it as empty, ensuring reset triggers are properly acknowledged even without additional body text.

---

## 01072 — chore: drop rpc->json fallback
**SHA:** c2adda1cfe · **Date:** 2025-12-10 15:58
**Files changed:** `src/auto-reply/command-reply.ts`
**Tags:** `cleanup`, `refactor`

Removed the RPC to JSON fallback mechanism that was attempting to retry on empty user text output, simplifying error handling and relying on stricter input validation instead.

---

## 01073 — gateway: force ws-only clients
**SHA:** 55772eec5a · **Date:** 2025-12-10 16:27
**Files changed:** `README.md`, `docs/gateway.md`
**Tags:** `cleanup`, `documentation`

Updated documentation to reflect that gateway client commands now assume a running gateway and no longer support the --spawn-gateway flag, consolidating to WebSocket-only client model.

---

## 01074 — health: stop direct baileys probes
**SHA:** 2967bc5988 · **Date:** 2025-12-10 16:35
**Files changed:** `src/commands/health.ts`
**Tags:** `cleanup`, `refactor`

Removed direct Baileys socket probing from health checks. Health command now reports only cached provider state from the running gateway instead of opening transient connections.

---

## 01075 — fix(session): ignore agent meta session id
**SHA:** 6c005b3d35 · **Date:** 2025-12-10 16:38
**Files changed:** `src/auto-reply/reply.ts`
**Tags:** `bugfix`, `config`

Disabled agent meta session ID updates temporarily (via allowMetaSessionId flag set to false) to work around instability in pi-mono's session ID persistence for custom paths.

---

## 01076 — health: gateway-only status and stable reconnect
**SHA:** e9fd73141d · **Date:** 2025-12-10 16:47
**Files changed:** `src/commands/health.ts`, `src/commands/status.ts`, `src/web/auto-reply.ts`
**Tags:** `refactor`, `core-feature`

Restructured health reporting to make gateway reachability the primary success metric, with provider issues reported but not fatal. Updated status output to reflect gateway-centric model.

---

## 01077 — feat(gateway): allow webchat port override
**SHA:** 93a5784c58 · **Date:** 2025-12-10 16:55
**Files changed:** `src/cli/program.ts`, `src/commands/health.ts`, `src/gateway/server.ts`
**Tags:** `core-feature`, `config`

Added --webchat-port option to gateway command to allow overriding the loopback WebChat HTTP server port (default 18788), with validation and passing through to server startup.

---

## 01078 — chore(gateway): log pre-hello ws closures
**SHA:** 27ad3b917f · **Date:** 2025-12-10 16:58
**Files changed:** `src/gateway/server.ts`
**Tags:** `logging`, `bugfix`

Enhanced logging for WebSocket closures before hello handshake completes, including connection ID and remote address, improving observability of early connection failures.

---

## 01079 — lint: format and stabilize gateway health
**SHA:** 47a1f757a9 · **Date:** 2025-12-10 18:00
**Files changed:** `src/auto-reply/reply.ts`, `src/auto-reply/reply.triggers.test.ts`, `src/web/auto-reply.ts`
**Tags:** `cleanup`, `refactor`

Code formatting and stabilization of gateway health checks, improving consistency and readability of health-related modules.

---

## 01080 — chore(gateway): use ws bind as lock
**SHA:** f417b51fb6 · **Date:** 2025-12-11 15:17
**Files changed:** `docs/gateway-lock.md`, `docs/test.md`, `src/gateway/server.test.ts`
**Tags:** `refactor`, `devops`

Switched gateway locking mechanism from file-based flock to WebSocket listener bind, eliminating stale lock files and enabling faster failure detection when port is occupied.

---

## 01081 — mac: replace xpc with unix socket control channel
**SHA:** 958c13e02d · **Date:** 2025-12-11 16:30
**Files changed:** `apps/macos/Package.resolved`, `apps/macos/Package.swift`, `apps/macos/Sources/Clawdis/Constants.swift`
**Tags:** `refactor`, `core-feature`

Removed AsyncXPCConnection dependency and replaced XPC inter-process communication with Unix socket-based control channel, simplifying architecture and improving reliability.

---

## 01082 — style(pi): wrap mode arg lookup
**SHA:** 768887fc0f · **Date:** 2025-12-11 18:53
**Files changed:** `src/agents/pi.ts`
**Tags:** `refactor`, `cleanup`

Reformatted pi agent mode argument lookup for better readability, breaking long lines to comply with style guidelines.

---

## 01083 — test(gateway): cover port lock guard
**SHA:** 0242383ec3 · **Date:** 2025-12-11 18:53
**Files changed:** `src/gateway/server.test.ts`
**Tags:** `testing`, `devops`

Added test coverage for WebSocket bind lock guard ensuring GatewayLockError is thrown when port is already in use, and verifying port is released after close.

---

## 01084 — web: default to self-only without config
**SHA:** f1ff24d634 · **Date:** 2025-12-12 00:50
**Files changed:** `src/auto-reply/reply.ts`, `src/web/auto-reply.test.ts`
**Tags:** `bugfix`, `config`

Implemented default self-only allowlist behavior when no allowFrom config is present, restricting replies to same-phone DMs by default for security.

---

## 01085 — mac: lock control socket to team-signed peers
**SHA:** 491fd6b74d · **Date:** 2025-12-12 01:22
**Files changed:** `apps/macos/Sources/Clawdis/ControlSocketServer.swift`
**Tags:** `security`, `core-feature`

Added peer verification logic to control socket handler using getsockopt(SOL_LOCAL, LOCAL_PEERPID) to accept only same-user or team-signed connections, improving security.

---

## 01086 — fix(mac): serialize gateway connect
**SHA:** 5f48abb451 · **Date:** 2025-12-12 14:12
**Files changed:** `apps/macos/Sources/Clawdis/GatewayChannel.swift`
**Tags:** `bugfix`, `core-feature`

Implemented serialization of concurrent gateway connect attempts using isConnecting flag and connectWaiters queue, preventing race conditions during WebSocket reconnection.

---

## 01087 — fix(mac): webchat ws connect
**SHA:** c8ca5803fc · **Date:** 2025-12-12 14:18
**Files changed:** `apps/macos/Sources/Clawdis/Resources/WebChat/index.html`, `apps/macos/Sources/Clawdis/WebChatWindow.swift`
**Tags:** `bugfix`, `ui`

Fixed WebChat WebSocket connection by adding gateway port resolution with proper remote tunnel support and updated CSP to allow WebSocket connections to gateway ports.

---

## 01088 — test(mac): cover concurrent gateway connect
**SHA:** 19e7c708ce · **Date:** 2025-12-12 14:29
**Files changed:** `apps/macos/Sources/Clawdis/GatewayChannel.swift`
**Tags:** `testing`, `core-feature`

Added test protocol abstractions (WebSocketTasking, WebSocketSessioning) to enable mocking of URLSession and WebSocket tasks, supporting concurrent connection testing.

---

## 01089 — fix(mac): keep webchat boot dots
**SHA:** 6b64039fcb · **Date:** 2025-12-12 15:01
**Files changed:** `apps/macos/Sources/Clawdis/Resources/WebChat/bootstrap.js`, `apps/macos/Sources/Clawdis/Resources/WebChat/webchat.bundle.js`
**Tags:** `bugfix`, `ui`

Fixed bootstrap loader to keep animated boot dots visible by storing status text in dataset instead of overwriting element content, improving user experience during loading.

---

## 01090 — fix(mac): cache webchat panel
**SHA:** b0384d0335 · **Date:** 2025-12-12 15:33
**Files changed:** `apps/macos/Sources/Clawdis/WebChatWindow.swift`
**Tags:** `bugfix`, `ui`, `performance`

Added panel session caching to prevent duplicate WebChat panel windows when toggling with different session keys. Panels now track which session they're bound to.

---

## 01091 — mac: add gog CLI, remove Gmail/Calendar MCPs
**SHA:** 7422f54212 · **Date:** 2025-12-12 15:48
**Files changed:** `apps/macos/Sources/Clawdis/ToolsSettings.swift`
**Tags:** `feature`, `dependency`

Replaced individual Gmail and Google Calendar MCP entries with unified gog CLI (via steipete/tap/gog), simplifying tool management and consolidating Google service access.

---

## 01092 — mac: remove voice wake forward pref
**SHA:** 679ced7840 · **Date:** 2025-12-12 16:09
**Files changed:** `apps/macos/Sources/Clawdis/AgentRPC.swift`, `apps/macos/Sources/Clawdis/AppState.swift`
**Tags:** `refactor`, `cleanup`

Removed voice wake forward target preference and simplified control request parameter types from AnyHashable to native Swift types for cleaner code.

---

## 01093 — Merge remote-tracking branch 'origin/main'
**SHA:** 3f1bcac077 · **Date:** 2025-12-12 16:10
**Files changed:** (merge commit)
**Tags:** `process-lifecycle`

Merge integration commit pulling remote main branch changes into working branch.

---

## 01094 — feat(voicewake): route replies to last channel
**SHA:** a524b9ae9b · **Date:** 2025-12-12 16:15
**Files changed:** `apps/macos/Sources/Clawdis/AgentRPC.swift`, `apps/macos/Sources/Clawdis/ControlRequestHandler.swift`, `apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift`, `src/config/sessions.ts`
**Tags:** `core-feature`, `api`

Implemented voice wake message routing to the last-used main surface (WhatsApp/Telegram/WebChat) with sessionKey and channel tracking, plus updateLastRoute function to persist routing metadata.

---

## 01095 — docs: clarify voice wake last-channel routing
**SHA:** 00336f554f · **Date:** 2025-12-12 16:26
**Files changed:** `CHANGELOG.md`, `README.md`, `docs/mac/voicewake.md`
**Tags:** `documentation`

Updated documentation to explain voice wake last-channel routing behavior and removal of forward target preferences, with updated feature descriptions reflecting new delivery model.

---

## 01096 — test: cover main last-channel routing
**SHA:** 9eda40234f · **Date:** 2025-12-12 16:35
**Files changed:** `src/config/sessions.test.ts`
**Tags:** `testing`, `core-feature`

Added test coverage for updateLastRoute function verifying that channel and target are persisted correctly in session store JSON alongside session metadata.

---

## 01097 — fix(mac): prevent crash decoding GatewayFrame
**SHA:** bf159bd316 · **Date:** 2025-12-12 16:37
**Files changed:** `apps/macos/Sources/ClawdisProtocol/GatewayModels.swift`, `scripts/protocol-gen-swift.ts`
**Tags:** `bugfix`, `core-feature`

Fixed GatewayFrame decoding by routing AnyCodable dictionary through JSONEncoder before JSONDecoder instead of directly using JSONSerialization, preventing crashes on complex payloads.

---

## 01098 — style(mac): hud glass voice overlay
**SHA:** af78762421 · **Date:** 2025-12-12 16:39
**Files changed:** (style changes only)
**Tags:** `ui`, `refactor`

Applied styling improvements to voice overlay HUD using glass morphism design principles for better visual presentation during voice wake and push-to-talk interactions.

---

## 01099 — Merge remote-tracking branch 'origin/main'
**SHA:** e6edcd9a7f · **Date:** 2025-12-12 16:39
**Files changed:** (merge commit)
**Tags:** `process-lifecycle`

Merge integration commit pulling remote main branch changes into working branch.

---

## 01100 — fix(macos): fix clawdis-mac --version
**SHA:** 88936b6216 · **Date:** 2025-12-12 16:40
**Files changed:** `apps/macos/Sources/ClawdisCLI/main.swift`
**Tags:** `bugfix`

Fixed --version flag output by improving Info.plist resolution (searching up to 10 directories with fallback to package.json version) and handling empty build string gracefully.

---
