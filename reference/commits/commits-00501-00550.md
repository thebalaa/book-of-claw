# Commit Reference: 00501–00550

A plain factual summary of every commit in the OpenClaw repository, from commit 501 through commit 550.

---

## 00501 — build: add mac icon pipeline
**SHA:** e528b439bc · **Date:** 2025-12-06 21:00
**Files changed:** apps/macos/Sources/Clawdis/Resources/Clawdis.icns, docs/clawdis-mac.md, scripts/build_icon.sh
**Tags:** `documentation`

Added build_icon.sh script to regenerate the macOS app icon from a glass .icon bundle using ictool/icontool and sips. The script renders a 824px inner art, pads to 1024px with transparent border, and generates all required iconset sizes. Updated docs to document the icon generation pipeline and default output paths.

---

## 00502 — mac: fix web chat boot in WKWebView
**SHA:** 6182b205c8 · **Date:** 2025-12-06 21:33
**Files changed:** apps/macos/Sources/Clawdis/WebChatWindow.swift, docs/webchat.md
**Tags:** `bugfix`, `ux`

Fixed import map paths for WKWebView by adding trailing slash aliases for all vendored packages to support deep imports. Added async IIFE wrapper and boot status logging via window.__clawdisLog to track module loading progress. Changed menu text from "Open Web Chat" to "Open Chat".

---

## 00503 — mac: fix notification prompt and center onboarding toggle
**SHA:** 39254229a0 · **Date:** 2025-12-06 21:38
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `bugfix`, `ux`

Fixed notification permission handling by checking all authorization states (authorized, provisional, ephemeral) and opening system settings when denied. Added PermissionMonitor with timer-based polling and reference counting for efficient status tracking. Centered the "Launch at login" toggle in the onboarding flow and moved test notification to Debug tab.

---

## 00504 — mac: streamline model config UI
**SHA:** c435236ceb · **Date:** 2025-12-06 21:39
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`, `refactor`

Removed the "Context tokens" input field from Config settings. Context window information is now displayed read-only below the model picker, derived automatically from the selected model's metadata. Removed contextTokens from config file serialization and loading logic.

---

## 00505 — feat(mac): add child relay process manager
**SHA:** 460d8fc094 · **Date:** 2025-12-06 22:05
**Files changed:** apps/macos/Package.resolved, apps/macos/Package.swift, apps/macos/Sources/Clawdis/AppMain.swift, apps/macos/Sources/Clawdis/RelayProcessManager.swift, docs/mac/child-process.md
**Tags:** `core-feature`, `process-lifecycle`, `dependency`

Added RelayProcessManager to spawn and supervise the relay as a child process using Swift Subprocess. Manages lifecycle (start/stop/restart), streams stdout/stderr to in-memory log buffer, and enforces crash backoff (3 crashes in 120 seconds triggers permanent failure). Added docs explaining child process mode vs launchd tradeoffs and TCC guardrails. Wired Active toggle to relay manager lifecycle.

---

## 00506 — feat: unify main session and icon cues
**SHA:** 4b6325908b · **Date:** 2025-12-06 23:16
**Files changed:** README.md, apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `core-feature`, `ux`

Unified direct chat sessions to a canonical "main" session key by default (configurable via inbound.reply.session.mainKey). WebChat now hydrates full history from the main session. Added isWorking and earBoostActive states to AppState with triggerVoiceEars method to show visual cues in the menu bar icon. Updated CritterStatusLabel to display working and ear boost states.

---

## 00507 — chore: remove bin/warelay.js
**SHA:** 56cedad707 · **Date:** 2025-12-06 23:17
**Files changed:** bin/warelay.js
**Tags:** `refactor`

Deleted the legacy bin/warelay.js entrypoint wrapper.

---

## 00508 — feat(macos): add tools tab installers
**SHA:** 16f452cf2e · **Date:** 2025-12-06 23:25
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift, apps/macos/Sources/Clawdis/ToolsSettings.swift
**Tags:** `ux`, `core-feature`

Added Tools tab to settings with card-based UI for installing dependencies (Homebrew, pnpm, MCP servers via MCPorter). Each card shows install method (brew/npm/go/mcporter), installation status with live path checking, and install buttons that trigger async shell commands. Includes preset cards for Anthropic MCP inspector, filesystem server, and Playwright server.

---

## 00509 — chore(mac): guard Darwin import for relay manager
**SHA:** b3564bf2b4 · **Date:** 2025-12-06 23:26
**Files changed:** apps/macos/Sources/Clawdis/RelayProcessManager.swift
**Tags:** `refactor`

Wrapped Darwin import in canImport check for cross-platform compatibility.

---

## 00510 — fix(macos): avoid voice tester crash
**SHA:** 89bb7d0211 · **Date:** 2025-12-06 23:39
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `bugfix`

Fixed actor isolation crash in VoiceWakeTester by hopping to MainActor before touching state in the recognition task callback. Added UIStrings enum for centralized string constants. Changed onboarding window to use fullSizeContentView with transparent titlebar and hidden title.

---

## 00511 — chore: move model reload to debug tab
**SHA:** ad2a26611a · **Date:** 2025-12-06 23:40
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`, `refactor`

Removed model catalog reload controls from Config tab. All model catalog management (choose file, reload, status) now lives exclusively in the Debug tab.

---

## 00512 — chore: reorder settings tabs
**SHA:** 649f644c75 · **Date:** 2025-12-06 23:41
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`

Reordered settings tabs to: General, Tools, Sessions, Config, Voice Wake, Permissions, Debug, About. Updated SettingsTab enum ordering to match.

---

## 00513 — feat(mac): show relay run indicator in menu
**SHA:** 58d0f3053d · **Date:** 2025-12-06 23:43
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`

Added relay status row to menu bar showing colored indicator dot (green=running, orange=starting/restarting, red=failed, gray=stopped) and status label. Positioned above the "Clawdis Active" toggle for immediate visibility.

---

## 00514 — chore: move relay status below toggles
**SHA:** 7daef74fc6 · **Date:** 2025-12-06 23:44
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`

Repositioned relay status row below the Active and Voice Wake toggles in the menu bar for better visual flow.

---

## 00515 — fix(mac): harden relay spawn path and show status
**SHA:** 7aca8d2d1c · **Date:** 2025-12-06 23:45
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift, apps/macos/Sources/Clawdis/RelayProcessManager.swift
**Tags:** `bugfix`, `core-feature`

Enhanced relay executable resolution by searching preferred paths (/opt/homebrew/bin, /usr/local/bin, etc.) for clawdis binary. Added environment PATH injection merging preferred paths with inherited environment. Fixed Accessibility permission prompt by passing proper options dictionary. Improved subprocess error reporting to show error codes.

---

## 00516 — build: sign debug app and use stable bundle id
**SHA:** 6dafca79be · **Date:** 2025-12-06 23:46
**Files changed:** scripts/package-mac-app.sh
**Tags:** `documentation`

Updated package-mac-app.sh to use stable debug bundle identifier (com.steipete.clawdis.debug) and call codesign-mac-app.sh for signing. This preserves TCC permissions across rebuilds by maintaining consistent bundle identity and code signature.

---

## 00517 — docs: document debug signing and bundle id
**SHA:** c3866b7d6b · **Date:** 2025-12-06 23:46
**Files changed:** docs/mac/signing.md
**Tags:** `documentation`

Documented that package-mac-app.sh now defaults to ad-hoc signing but supports SIGN_IDENTITY environment variable for real certificates. Explained why consistent signing and bundle ID are necessary to preserve TCC permissions between debug builds.

---

## 00518 — fix(mac): resolve relay executable via common paths and pnpm fallback
**SHA:** 51a4b86495 · **Date:** 2025-12-06 23:48
**Files changed:** apps/macos/Sources/Clawdis/RelayProcessManager.swift
**Tags:** `bugfix`, `core-feature`

Added findExecutable helper that searches preferred paths for binaries. Enhanced relay command resolution with fallback chain: system clawdis, pnpm clawdis relay, node bin/warelay.js. Added node_modules/.bin and ~/Library/pnpm to preferred paths. Introduced defaultProjectRoot helper that checks ~/Projects/clawdis existence.

---

## 00519 — fix(mac): run pnpm from project root and set PNPM_HOME for relay
**SHA:** ec00e0a952 · **Date:** 2025-12-06 23:49
**Files changed:** apps/macos/Sources/Clawdis/RelayProcessManager.swift
**Tags:** `bugfix`

Added working directory configuration to relay spawn, setting cwd to defaultProjectRoot. Enhanced environment builder to inject PNPM_HOME pointing to ~/Library/pnpm alongside PATH updates. This ensures pnpm can find its global store and project-local binaries.

---

## 00520 — feat(mac): make relay project root configurable from Debug tab
**SHA:** c9f5edbc1d · **Date:** 2025-12-06 23:51
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift, apps/macos/Sources/Clawdis/RelayProcessManager.swift
**Tags:** `ux`, `core-feature`

Added "Relay project root" configuration field to Debug tab with save/reset buttons. RelayProcessManager now reads project root from UserDefaults (key: clawdis.relayProjectRootPath) with tilde expansion support. This path is used for pnpm/node fallback resolution and cwd when launching relay.

---

## 00521 — feat(mac): show relay attention badge without dimming paused state
**SHA:** ff36375581 · **Date:** 2025-12-06 23:54
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`

Changed relay status indicator to show attention state (non-running statuses highlighted) without dimming the overall paused appearance. This makes relay failures more visible even when Clawdis is paused.

---

## 00522 — chore(mac): rename relay root label to Clawdis project root
**SHA:** b25b72ae19 · **Date:** 2025-12-06 23:56
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `naming`

Renamed debug setting label from "Relay project root" to "Clawdis project root" for clarity.

---

## 00523 — fix(mac): run relay with cwd set to configured project root
**SHA:** 02e26996c1 · **Date:** 2025-12-06 23:57
**Files changed:** apps/macos/Sources/Clawdis/RelayProcessManager.swift
**Tags:** `bugfix`, `core-feature`

Changed relay spawn to set workingDirectory from configured project root instead of inheriting app's cwd. This ensures relay runs from the correct repository directory for accessing config files and node_modules.

---

## 00524 — docs: add 500 LOC cap to guardrails
**SHA:** 9c32e630a0 · **Date:** 2025-12-06 23:59
**Files changed:** docs/guards.md
**Tags:** `documentation`

Added guideline that Claude should propose splitting modules when a single source file approaches 500 lines of code.

---

## 00525 — fix(mac): bundle web chat UI deps
**SHA:** c5c50a2141 · **Date:** 2025-12-07 00:05
**Files changed:** apps/macos/Sources/Clawdis/Resources/WebChat/pi-ai-stub.js, apps/macos/Sources/Clawdis/Resources/WebChat/vendor/@lmstudio/sdk/LICENSE, apps/macos/Sources/Clawdis/WebChatWindow.swift
**Tags:** `bugfix`, `dependency`

Bundled web chat UI dependencies in app resources to eliminate network fetches. Added pi-ai-stub.js as a minimal browser-friendly stub for @mariozechner/pi-ai. Updated WebChat import map to use bundled vendor files under Resources/WebChat/vendor/. This fixes offline usage and eliminates external CDN dependencies.

---

## 00526 — macOS: split AppMain into focused modules
**SHA:** 82e751a153 · **Date:** 2025-12-07 00:10
**Files changed:** apps/macos/Sources/Clawdis/AboutSettings.swift, apps/macos/Sources/Clawdis/AppMain.swift, apps/macos/Sources/Clawdis/AppState.swift, apps/macos/Sources/Clawdis/ConfigSettings.swift, apps/macos/Sources/Clawdis/Constants.swift, apps/macos/Sources/Clawdis/DebugSettings.swift, apps/macos/Sources/Clawdis/GeneralSettings.swift, apps/macos/Sources/Clawdis/Onboarding.swift, apps/macos/Sources/Clawdis/PermissionsSettings.swift, apps/macos/Sources/Clawdis/SessionsSettings.swift, apps/macos/Sources/Clawdis/SettingsRootView.swift, apps/macos/Sources/Clawdis/Utilities.swift, apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `refactor`

Split monolithic AppMain.swift (3000+ lines) into focused modules: AppState.swift, Constants.swift, Utilities.swift, and separate files for each settings tab (GeneralSettings, VoiceWakeSettings, ConfigSettings, PermissionsSettings, SessionsSettings, DebugSettings, AboutSettings), Onboarding.swift, and SettingsRootView.swift. Each module now owns a single concern for maintainability.

---

## 00527 — chore: fix swiftlint after split
**SHA:** 7b7c4bd116 · **Date:** 2025-12-07 00:14
**Files changed:** .swiftlint.yml
**Tags:** `linting`

Updated swiftlint configuration to exclude build directories and adjust rules post-refactor.

---

## 00528 — docs: update relay run mode
**SHA:** ab316b348a · **Date:** 2025-12-07 00:16
**Files changed:** docs/clawdis-mac.md
**Tags:** `documentation`

Updated documentation to reflect that relay now runs as a child process of the menu bar app instead of via launchd. Documented configurable project root for relay execution.

---

## 00529 — fix: remove legacy relay references
**SHA:** 757cedc233 · **Date:** 2025-12-06 23:21
**Files changed:** apps/macos/Sources/Clawdis/Utilities.swift
**Tags:** `refactor`

Removed references to warelay in favor of unified clawdis relay command.

---

## 00530 — mac: add signing helper and document debug bundle
**SHA:** b2e3013898 · **Date:** 2025-12-07 00:30
**Files changed:** docs/mac/signing.md, scripts/codesign-mac-app.sh
**Tags:** `documentation`, `core-feature`

Added codesign-mac-app.sh script to handle code signing with hardened runtime and automation entitlements. Script signs main binary, CLI helper, and app bundle. Documented build metadata stamping (ClawdisBuildTimestamp and ClawdisGitCommit) that package-mac-app.sh injects into Info.plist for About pane display.

---

## 00531 — mac: show build metadata in About
**SHA:** 0a6b934ac1 · **Date:** 2025-12-07 00:30
**Files changed:** apps/macos/Sources/Clawdis/AboutSettings.swift
**Tags:** `ux`

Updated About tab to display build timestamp (formatted from ClawdisBuildTimestamp Info.plist key) alongside version and git commit. Added hover effect to app icon with shadow and scale animation.

---

## 00532 — Mac: fix permission prompt crash
**SHA:** 515e973964 · **Date:** 2025-12-06 23:31
**Files changed:** apps/macos/Sources/Clawdis/PermissionsSettings.swift
**Tags:** `bugfix`

Fixed permission request flow to use PermissionManager.ensure instead of directly calling TCC APIs. This prevents crashes from duplicate or improper permission prompts.

---

## 00533 — Docs: note SIGN_IDENTITY for mac signing
**SHA:** 4426bf2615 · **Date:** 2025-12-06 23:45
**Files changed:** docs/mac/signing.md
**Tags:** `documentation`

Added example showing how to use SIGN_IDENTITY environment variable with Developer ID certificate when running package-mac-app.sh.

---

## 00534 — mac: tidy About metadata layout
**SHA:** 11311d07e5 · **Date:** 2025-12-07 00:48
**Files changed:** apps/macos/Sources/Clawdis/AboutSettings.swift
**Tags:** `ux`

Improved About tab layout by adjusting spacing and alignment of version, build timestamp, and git commit information.

---

## 00535 — Mac: add mic entitlement to signing helper
**SHA:** 21bb2fb03f · **Date:** 2025-12-06 23:52
**Files changed:** scripts/codesign-mac-app.sh
**Tags:** `core-feature`

Added microphone usage entitlement to codesign-mac-app.sh for voice wake functionality.

---

## 00536 — Mac: fix voice wake actor crash; add mic entitlement
**SHA:** ce02f798e4 · **Date:** 2025-12-07 00:10
**Files changed:** apps/macos/Package.swift
**Tags:** `bugfix`

Added missing microphone entitlement to Package.swift target configuration to prevent voice wake crashes when accessing audio input.

---

## 00537 — Mac: remove Tools & MCP header
**SHA:** c911568306 · **Date:** 2025-12-07 00:16
**Files changed:** apps/macos/Sources/Clawdis/ToolsSettings.swift
**Tags:** `ux`

Removed "Tools & MCP" header from tools tab for cleaner UI.

---

## 00538 — Mac: lighten tool cards
**SHA:** 9ef8cdadf6 · **Date:** 2025-12-07 00:17
**Files changed:** apps/macos/Sources/Clawdis/ToolsSettings.swift
**Tags:** `ux`

Reduced visual weight of tool installation cards by adjusting background opacity and border styling.

---

## 00539 — Mac: privileged CLI helper install via osascript
**SHA:** 567644dabd · **Date:** 2025-12-07 00:50
**Files changed:** apps/macos/Sources/Clawdis/Utilities.swift
**Tags:** `core-feature`, `ux`

Changed CLI helper installation to use osascript with administrator privileges instead of direct filesystem operations. This properly handles permission escalation for symlinking into /usr/local/bin and /opt/homebrew/bin. Added shell escape helper to prevent injection attacks.

---

## 00540 — CLI: add --help and usage
**SHA:** 8b20e0166d · **Date:** 2025-12-07 00:53
**Files changed:** apps/macos/Sources/ClawdisCLI/main.swift
**Tags:** `ux`, `documentation`

Added --help/-h/help command that prints comprehensive usage documentation showing all available commands (notify, ensure-permissions, screenshot, run, status) with their parameters and JSON response format.

---

## 00541 — CLI: add --version flag
**SHA:** 0f71667625 · **Date:** 2025-12-07 00:55
**Files changed:** apps/macos/Sources/ClawdisCLI/main.swift
**Tags:** `ux`

Added --version/-V/version command that triggers version output.

---

## 00542 — CLI: fix --version by reading app Info.plist
**SHA:** 9497a4cb5a · **Date:** 2025-12-07 00:59
**Files changed:** apps/macos/Sources/ClawdisCLI/main.swift
**Tags:** `bugfix`, `ux`

Implemented printVersion to read CFBundleShortVersionString, CFBundleVersion, ClawdisGitCommit, and ClawdisBuildTimestamp from Info.plist and format a comprehensive version string showing version, build number, git commit, and build timestamp.

---

## 00543 — Mac: align app version with package.json
**SHA:** 00ef7ec522 · **Date:** 2025-12-07 01:00
**Files changed:** apps/macos/Package.swift
**Tags:** `refactor`

Synchronized macOS app version metadata with root package.json version.

---

## 00544 — chore(mac): move relay status row directly under Active toggle
**SHA:** 6355113af9 · **Date:** 2025-12-07 01:16
**Files changed:** apps/macos/Sources/Clawdis/AppMain.swift
**Tags:** `ux`

Repositioned relay status row to appear immediately after the "Clawdis Active" toggle in the menu for better visual association.

---

## 00545 — VoiceWake: add SSH forward target
**SHA:** cf0f44823a · **Date:** 2025-12-07 01:53
**Files changed:** apps/macos/Sources/Clawdis/AppState.swift, apps/macos/Sources/Clawdis/Constants.swift, apps/macos/Sources/Clawdis/VoiceWakeActor.swift, apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift, apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `core-feature`

Added SSH forwarding capability to voice wake system. Introduced VoiceWakeForwardConfig with target (user@host:port), identityPath, commandTemplate, and timeout. VoiceWakeForwarder spawns ssh process to execute remote command with transcript substitution. Added voice wake forward settings UI with target, identity path, command template, and enable toggle. Migrated legacy host/user/port settings to unified target string format.

---

## 00546 — VoiceWake: add SSH forwarder tests
**SHA:** 141d2b5626 · **Date:** 2025-12-07 01:55
**Files changed:** apps/macos/Package.swift, apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift, apps/macos/Tests/ClawdisIPCTests/VoiceWakeForwarderTests.swift
**Tags:** `testing`, `core-feature`

Added ClawdisIPCTests target dependency on Clawdis. Created VoiceWakeForwarderTests with Swift Testing to verify command rendering, target parsing (user@host:port variations), and template variable substitution. Made renderedCommand and parse functions internal for testability.

---

## 00547 — Settings: keep tabs fixed, only content scrolls
**SHA:** b27f0dd490 · **Date:** 2025-12-07 01:56
**Files changed:** apps/macos/Sources/Clawdis/SettingsRootView.swift
**Tags:** `ux`

Changed settings window layout so tab bar remains fixed at top while only tab content scrolls. Wrapped individual tab content in ScrollView instead of wrapping entire TabView.

---

## 00548 — VoiceWake: add SSH connectivity check UI
**SHA:** 374472deda · **Date:** 2025-12-07 02:03
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift, apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `ux`, `core-feature`

Added SSH connectivity check button to Voice Wake settings that tests connection with BatchMode and 4-second timeout. Shows async status (checking/success/failure) with colored indicators. VoiceWakeForwarder.checkConnection validates target format, runs ssh with ConnectTimeout, and returns Result with descriptive error types (invalidTarget, launchFailed, nonZeroExit).

---

## 00549 — Mac: run via launchd agent with mach service
**SHA:** f4f4f2d314 · **Date:** 2025-12-07 01:05
**Files changed:** scripts/restart-mac.sh
**Tags:** `process-lifecycle`, `core-feature`

Changed restart-mac.sh to install launchd agent plist with MachServices entry for com.steipete.clawdis.xpc. Uses launchctl bootstrap/kickstart to run app as persistent agent with KeepAlive. Logs to /tmp/clawdis.log via StandardOutPath/StandardErrorPath.

---

## 00550 — Mac: let launch checkbox toggle launchd agent
**SHA:** 699cb92e86 · **Date:** 2025-12-07 01:09
**Files changed:** apps/macos/Sources/Clawdis/AppState.swift, apps/macos/Sources/Clawdis/Utilities.swift
**Tags:** `core-feature`, `ux`

Replaced SMAppService.mainApp with LaunchAgentManager for launch-at-login control. LaunchAgentManager writes plist to ~/Library/LaunchAgents/ and uses launchctl bootstrap/bootout to manage persistent launchd agent with Mach service. Status checking uses launchctl print to verify agent state. This provides more control and visibility than SMAppService.

---
