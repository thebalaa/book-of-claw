# Commit Reference: 00551–00600

A plain factual summary of every commit in the OpenClaw repository, from commit 551 through commit 600.

---

## 00551 — Mac: disable KeepAlive; launch toggle controls agent
**SHA:** ea9930816f · **Date:** 2025-12-07 01:13
**Files changed:** apps/macos/Sources/Clawdis/Utilities.swift
**Tags:** `process-lifecycle`, `refactor`

Removed KeepAlive key from the launch agent plist template generated by LaunchAgentManager. The launch agent now starts at load but does not automatically restart on exit, giving users direct control over when the agent runs.

---

## 00552 — scripts: make restart clean step resilient
**SHA:** f51f8ffe45 · **Date:** 2025-12-07 02:04
**Files changed:** scripts/restart-mac.sh
**Tags:** `bugfix`

Made the build cache cleanup step in restart-mac.sh resilient by adding `2>/dev/null || true` to the rm command. This prevents script failure when .build directories don't exist or are already deleted.

---

## 00553 — VoiceWake: better ssh target parsing and error detail
**SHA:** 1d807911e4 · **Date:** 2025-12-07 02:11
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift, apps/macos/Sources/ClawdisCLI/main.swift
**Tags:** `ux`, `bugfix`

Enhanced VoiceWakeForwarder to capture stderr/stdout from SSH processes and include output in error messages. Added sanitizedTarget helper to strip "ssh " prefix from targets, improved SSH target parsing to handle prefixes, and updated nonZeroExit error to include up to 240 characters of output for debugging.

---

## 00554 — VoiceWake: make tab content scrollable
**SHA:** 9d0415f9e9 · **Date:** 2025-12-07 02:12
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `ux`

Wrapped VoiceWakeSettings tab content in ScrollView to prevent UI overflow when window is resized or content expands. Adjusted padding to work within scroll container.

---

## 00555 — VoiceWake: keep listening until silence, gate enable on permissions
**SHA:** e906b87450 · **Date:** 2025-12-07 02:18
**Files changed:** apps/macos/Sources/Clawdis/AppState.swift, apps/macos/Sources/Clawdis/MenuBar.swift, apps/macos/Sources/Clawdis/PermissionManager.swift, apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `core-feature`, `ux`

Added holdUntilSilence behavior to VoiceWakeTester that continues listening for 1 second after wake word detection to capture full user utterance. Implemented permission gating for voice wake: enabling now checks microphone and speech recognition permissions interactively before allowing activation. Added PermissionManager.voiceWakePermissionsGranted and ensureVoiceWakePermissions helpers.

---

## 00556 — fix: gate voice wake permissions
**SHA:** bac5ac18f7 · **Date:** 2025-12-07 02:19
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `bugfix`, `verbosity`

Added logging to voice wake detection events. VoiceWakeTester now logs when wake phrase is detected and when hold-until-silence finishes, recording transcript length for debugging.

---

## 00557 — VoiceWake: log detection, hold to 1s silence, ssh log clarity
**SHA:** e27690e894 · **Date:** 2025-12-07 02:24
**Files changed:** apps/macos/Sources/Clawdis/PermissionManager.swift, apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift, apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `core-feature`, `verbosity`, `ux`

Added AppleScriptPermission enum with TCC automation permission checking for controlling Terminal. Enhanced VoiceWakeForwarder logging to include host info on success/failure. Fixed speech recognition permission request to use UnsafeContinuation and dispatch back to main thread, resolving authorization callback issues.

---

## 00558 — tools: add clawlog helper for unified logs
**SHA:** bc20664c18 · **Date:** 2025-12-07 02:25
**Files changed:** scripts/clawlog.sh
**Tags:** `verbosity`, `documentation`

Added clawlog.sh utility script for accessing macOS unified logging system with full privacy data using sudo. Supports streaming mode, time range filters, category filtering, error-only mode, search text, JSON output, and log export. Includes detailed help text documenting subsystem com.steipete.clawdis and common categories.

---

## 00559 — VoiceWake: compact SSH test row
**SHA:** 3a4bf8f213 · **Date:** 2025-12-07 02:32
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `ux`

Redesigned SSH connection test UI to be more compact. Combined SSH target field, status icon, and test button into a single horizontal row. Moved error message display below the controls instead of inline, using up to 5 lines for detailed output.

---

## 00560 — VoiceWake: align mic + level rows
**SHA:** 752bc5a454 · **Date:** 2025-12-07 02:32
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `ux`

Aligned microphone picker and live level meter rows using consistent 110pt label width. Replaced LabeledContent with HStack layout, added fixed widths for level bar (260pt) and level text (60pt) for visual consistency.

---

## 00561 — VoiceWake: stabilize test card height
**SHA:** 2e67c5a045 · **Date:** 2025-12-07 02:33
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeSettings.swift
**Tags:** `ux`

Fixed voice wake test card height jumping by setting status text maxHeight to 22 and card minHeight to 54. Prevents UI layout shifts during state transitions between listening, hearing, and detected states.

---

## 00562 — feat(mac): add automation permission
**SHA:** ea37ee6cb3 · **Date:** 2025-12-07 02:34
**Files changed:** apps/macos/Sources/Clawdis/PermissionsSettings.swift, apps/macos/Sources/ClawdisIPC/IPC.swift, docs/clawdis-mac.md, scripts/package-mac-app.sh
**Tags:** `core-feature`, `documentation`

Added appleScript capability to Capability enum for TCC Automation permission. Updated PermissionRow to display "Automation (AppleScript)" with applescript icon and description. Added NSAppleEventsUsageDescription to Info.plist explaining need to control Terminal and other apps for agent actions.

---

## 00563 — Mac: stabilize XPC and voice wake handling
**SHA:** 78c67ed53d · **Date:** 2025-12-07 02:09
**Files changed:** apps/macos/Sources/Clawdis/MenuBar.swift, apps/macos/Sources/Clawdis/PermissionManager.swift, apps/macos/Sources/Clawdis/VoiceWakeSettings.swift, apps/macos/Sources/ClawdisCLI/main.swift, scripts/restart-mac.sh
**Tags:** `bugfix`, `process-lifecycle`, `refactor`

Fixed XPC connection reliability by adding retry logic (up to 10 attempts with 100ms delay) in CLI send function. Added duplicate instance detection in AppDelegate to terminate if another Clawdis instance is running. Fixed voice wake handleResult to properly dispatch UI updates to MainActor. Removed launchd-based launch agent setup from restart script, relying on direct app launch instead. CLI now ensures app is running before attempting XPC connection.

---

## 00564 — Mac: secure XPC and register mach service via launchd
**SHA:** aeb708fe07 · **Date:** 2025-12-07 02:27
**Files changed:** apps/macos/Sources/Clawdis/MenuBar.swift, scripts/package-mac-app.sh
**Tags:** `core-feature`, `refactor`

Implemented XPC connection security by validating client code signatures against allowed team IDs (Y5PE65HELJ). Added isAllowed method checking audit token or pid-based SecCode validation, with same-user fallback using sysctl to get process credentials. Rejects unauthorized XPC connections before processing requests.

---

## 00565 — Docs: describe mac XPC setup
**SHA:** cdbbdcba5f · **Date:** 2025-12-07 02:27
**Files changed:** docs/clawdis-mac.md
**Tags:** `documentation`

Updated clawdis-mac.md to document XPC mach service registration, team ID validation for secure connections, and the communication flow between CLI and app. Describes how NSXPCListener advertises com.steipete.clawdis.xpc service.

---

## 00566 — Docs: add clawlog helper note
**SHA:** ea83982062 · **Date:** 2025-12-07 03:30
**Files changed:** docs/clawdis-mac.md
**Tags:** `documentation`

Added documentation for clawlog.sh utility script in debugging section. Describes how to access unified logs with sudo for full privacy data visibility.

---

## 00567 — chore(mac): add webchat auto-open flag and verbose logging
**SHA:** 71c5511e6c · **Date:** 2025-12-07 03:31
**Files changed:** apps/macos/Sources/Clawdis/MenuBar.swift, apps/macos/Sources/Clawdis/WebChatManager.swift
**Tags:** `verbosity`, `ux`

Added autoOpenWebChat flag to WebChatManager for controlling whether webchat window opens automatically on show(). Enhanced logging to include window open/focus/creation events and visibility state changes for debugging webchat behavior.

---

## 00568 — docs(mac): document webchat auto-open and debug flow
**SHA:** 5d5e7393f8 · **Date:** 2025-12-07 03:34
**Files changed:** docs/clawdis-mac.md
**Tags:** `documentation`

Updated documentation to explain webchat auto-open flag behavior and typical debug flow when troubleshooting webchat visibility issues. Clarifies when window is created vs shown vs focused.

---

## 00569 — fix(mac): bundle WebChat resources when packaging
**SHA:** 40013c2b61 · **Date:** 2025-12-07 03:36
**Files changed:** scripts/package-mac-app.sh
**Tags:** `bugfix`

Fixed missing webchat UI by copying shared/webchat/ directory into app bundle Resources during packaging. Ensures static HTML/CSS/JS files are available at runtime for WebChatManager to load.

---

## 00570 — Mac: allow signed CLI + same-uid XPC clients
**SHA:** 3c61524f26 · **Date:** 2025-12-07 02:48
**Files changed:** apps/macos/Sources/Clawdis/MenuBar.swift, apps/macos/Sources/ClawdisCLI/main.swift
**Tags:** `refactor`, `bugfix`

Refactored XPC security to prioritize same-user check before team ID validation. Added uid helper using sysctl to get process credentials. This allows ad-hoc signed CLI binaries to connect as long as they run as same user, while still validating team ID for properly signed clients. Silenced open command output in ensureAppRunning.

---

## 00571 — VoiceWake: ssh check also verifies remote clawdis-mac
**SHA:** 759ab54e59 · **Date:** 2025-12-07 03:53
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift
**Tags:** `core-feature`, `ux`

Enhanced SSH connection test to verify both basic connectivity and presence of remote clawdis-mac CLI. Split checkConnection into two stages: first runs "true" to verify SSH works, then runs "which clawdis-mac" to confirm helper is installed. Added cliMissingOrFailed error case with descriptive message.

---

## 00572 — fix: ensure remote clawdis-mac path
**SHA:** faca83e1e8 · **Date:** 2025-12-07 04:12
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift
**Tags:** `bugfix`

Updated remote CLI detection to check /usr/local/bin/clawdis-mac explicitly instead of relying on which command. Ensures voice wake SSH forwarding can locate the helper even if PATH is not fully configured in non-interactive SSH sessions.

---

## 00573 — fix: stabilize tools action width
**SHA:** c74c1a0c5f · **Date:** 2025-12-07 04:13
**Files changed:** apps/macos/Sources/Clawdis/ToolsSettings.swift
**Tags:** `ux`

Fixed tools settings action column width to prevent button text truncation. Set fixed width for action buttons to ensure consistent layout across different button labels.

---

## 00574 — Mac: link Debug log button to pino log
**SHA:** fdfcff2bb5 · **Date:** 2025-12-07 03:15
**Files changed:** apps/macos/Sources/Clawdis/DebugSettings.swift
**Tags:** `verbosity`, `ux`

Changed Debug settings "View log" button to open pino JSON log file at /tmp/clawdis/relay.log instead of unified log. Provides direct access to structured relay process logs.

---

## 00575 — Mac: debug log button falls back to legacy path
**SHA:** 36ba1ff790 · **Date:** 2025-12-07 03:20
**Files changed:** apps/macos/Sources/Clawdis/DebugSettings.swift
**Tags:** `bugfix`

Added fallback logic to check ~/.clawdis/relay.log if /tmp/clawdis/relay.log doesn't exist. Ensures log viewing works for both new and legacy log locations.

---

## 00576 — Mac: debug log button shows path and opens in Finder
**SHA:** 33396ca9c1 · **Date:** 2025-12-07 03:29
**Files changed:** apps/macos/Sources/Clawdis/DebugSettings.swift
**Tags:** `ux`

Enhanced debug log UI to display the actual log file path being used and changed button to open containing folder in Finder instead of opening file directly. Helps users locate log files for sharing or inspection.

---

## 00577 — Logging: use /tmp/clawdis for default pino logs
**SHA:** 1a10569f6d · **Date:** 2025-12-07 03:32
**Files changed:** src/server/logger.ts
**Tags:** `refactor`

Changed default pino log directory from ~/.clawdis to /tmp/clawdis for better tmpfs performance and automatic cleanup. Log files are transient and don't need to persist across reboots.

---

## 00578 — feat(macos): detect installed CLI helper
**SHA:** 21dfbd0103 · **Date:** 2025-12-07 04:35
**Files changed:** apps/macos/Sources/Clawdis/DebugSettings.swift
**Tags:** `ux`

Added CLI helper detection to Debug settings showing whether /usr/local/bin/clawdis-mac exists and is executable. Displays green checkmark if installed, warning icon with installation instructions if missing.

---

## 00579 — chore: purge warelay references
**SHA:** 6c3d3b98b8 · **Date:** 2025-12-07 03:36
**Files changed:** CHANGELOG.md, README.md, docs/
**Tags:** `naming`, `refactor`

Renamed project references from "warelay" to "clawdis" throughout CHANGELOG.md and documentation. Updated IPC socket path references from ~/.warelay to ~/.clawdis and command examples to use clawdis prefix.

---

## 00580 — feat: add icon animation setting
**SHA:** 060f80c239 · **Date:** 2025-12-07 04:38
**Files changed:** apps/macos/Sources/Clawdis/AppState.swift, apps/macos/Sources/Clawdis/MenuBar.swift
**Tags:** `ux`

Added disableIconAnimation toggle to AppState persisted via UserDefaults. When enabled, prevents menu bar icon from animating during voice activity and working states. Allows users to disable distracting animations.

---

## 00581 — build: require signing identity for mac packaging
**SHA:** f23b16db2b · **Date:** 2025-12-07 04:38
**Files changed:** scripts/package-mac-app.sh
**Tags:** `refactor`

Changed package-mac-app.sh to exit with error if SIGN_IDENTITY is not set, removing ad-hoc signing fallback. Ensures all packaged apps are properly signed for distribution and XPC team ID validation.

---

## 00582 — CLI: allow --provider flag for login/logout (default whatsapp)
**SHA:** 31f788eb5e · **Date:** 2025-12-07 03:41
**Files changed:** src/cli/program.ts
**Tags:** `provider`, `ux`

Added --provider flag to login and logout CLI commands with default value "whatsapp". Allows explicit selection of provider backend when logging in or clearing credentials.

---

## 00583 — Mac: add relay restart button in Debug
**SHA:** 050ebb3b19 · **Date:** 2025-12-07 03:42
**Files changed:** apps/macos/Sources/Clawdis/DebugSettings.swift
**Tags:** `ux`, `process-lifecycle`

Added "Restart relay" button to Debug settings that terminates the clawdis CLI relay process. Next IPC request will automatically spawn a fresh relay instance, useful for recovering from hung states.

---

## 00584 — fix: harden remote voice wake CLI lookup
**SHA:** 55e0086958 · **Date:** 2025-12-07 04:43
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeForwarder.swift
**Tags:** `bugfix`

Enhanced remote CLI detection to try multiple paths (/usr/local/bin/clawdis-mac, ~/bin/clawdis-mac) and use test -x to verify file exists and is executable. Provides better error message when CLI is missing or not executable on remote host.

---

## 00585 — test: add voice wake forwarder cache coverage
**SHA:** ca4e76b34f · **Date:** 2025-12-07 04:52
**Files changed:** apps/macos/Tests/VoiceWakeTests.swift
**Tags:** `testing`

Added unit tests for VoiceWakeForwarder's remote CLI path caching behavior. Verifies that successful CLI detection result is cached and reused for subsequent forward calls to avoid repeated SSH checks.

---

## 00586 — feat(macos): run live voice wake listener and animate ears
**SHA:** 38abb044d0 · **Date:** 2025-12-07 04:52
**Files changed:** apps/macos/Sources/Clawdis/AppState.swift, apps/macos/Sources/Clawdis/MenuBar.swift, apps/macos/Sources/Clawdis/VoiceWakeRuntime.swift
**Tags:** `core-feature`, `ux`

Implemented VoiceWakeRuntime as a persistent background listener that runs continuously when voice wake is enabled. Automatically starts/stops recognition when swabbleEnabled toggles, triggers ear animation on detection, and forwards transcripts to SSH target. Replaces one-shot test harness with production runtime.

---

## 00587 — test(voicewake): cover trigger matching for runtime listener
**SHA:** 55ea0f398b · **Date:** 2025-12-07 04:53
**Files changed:** apps/macos/Tests/VoiceWakeTests.swift
**Tags:** `testing`

Added unit tests for VoiceWakeRuntime trigger word matching logic. Verifies that configured trigger phrases are correctly detected in transcription results and fire forwarding actions.

---

## 00588 — fix(voicewake): log ssh/cli failure instead of staying silent
**SHA:** f1dbff1dd4 · **Date:** 2025-12-07 04:58
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeRuntime.swift
**Tags:** `verbosity`, `bugfix`

Added error logging to VoiceWakeRuntime when SSH forward or remote CLI execution fails. Previously failures were silent; now logs include error details to unified log for debugging.

---

## 00589 — feat(cli): add agent send command and wire through XPC
**SHA:** a489550752 · **Date:** 2025-12-07 05:00
**Files changed:** apps/macos/Sources/Clawdis/ClawdisXPCService.swift, apps/macos/Sources/ClawdisIPC/IPC.swift, apps/macos/Sources/ClawdisCLI/main.swift
**Tags:** `core-feature`

Added agentSend request type to IPC protocol and clawdis-mac agent command to CLI. XPC service spawns clawdis agent CLI with provided text/session/thinking options and streams back JSON response chunks. Enables macOS app to invoke agent via privileged helper without direct relay IPC access.

---

## 00590 — Mac: fix agent XPC by invoking CLI agent
**SHA:** bbe92a3a40 · **Date:** 2025-12-07 04:03
**Files changed:** apps/macos/Sources/Clawdis/ClawdisXPCService.swift
**Tags:** `bugfix`

Fixed agentSend XPC implementation to locate and invoke clawdis CLI binary correctly. Added proper PATH resolution and argument construction for agent command with JSON output mode.

---

## 00591 — fix(webchat): wire agent CLI send into web chat view
**SHA:** cac988f8e2 · **Date:** 2025-12-07 05:04
**Files changed:** apps/macos/Sources/Clawdis/WebChatView.swift
**Tags:** `bugfix`

Connected webchat message sending to use agentSend XPC request. WebChatView now invokes clawdis-mac agent command via XPC when user submits message, streaming back agent response chunks to display.

---

## 00592 — docs: outline RPC plan for agent CLI
**SHA:** e1c4a5989b · **Date:** 2025-12-07 05:08
**Files changed:** docs/agent-rpc.md
**Tags:** `documentation`

Added design document for agent RPC worker architecture. Describes stdin/stdout JSON-RPC loop protocol where persistent clawdis rpc process handles agent sends without spawning new Node.js processes per request, improving latency and resource usage.

---

## 00593 — feat(cli): add stdin/stdout rpc loop for agent sends
**SHA:** 0a9b98ed67 · **Date:** 2025-12-07 05:10
**Files changed:** src/cli/program.ts
**Tags:** `core-feature`

Implemented clawdis rpc command that runs persistent stdin/stdout JSON-RPC loop. Accepts {type:"send", text, to, session, thinking} requests on stdin, executes agent send via shared relay IPC, and streams response chunks as JSON to stdout. Enables low-latency agent interaction for XPC service.

---

## 00594 — feat(agent): use persistent rpc worker for agent sends
**SHA:** 69cb71ad7e · **Date:** 2025-12-07 05:14
**Files changed:** apps/macos/Sources/Clawdis/ClawdisXPCService.swift
**Tags:** `core-feature`, `optimization`

Refactored agentSend XPC implementation to use long-running clawdis rpc worker instead of spawning new CLI process per request. XPC service maintains persistent Process with stdin/stdout pipes, sends JSON RPC requests, and parses streaming response chunks.

---

## 00595 — chore(agent): drop cli fallback, rpc only for sends
**SHA:** fb1de5c1c6 · **Date:** 2025-12-07 05:16
**Files changed:** apps/macos/Sources/Clawdis/ClawdisXPCService.swift
**Tags:** `refactor`

Removed fallback to direct agent CLI invocation, making RPC worker the sole path for agent sends. Simplifies XPC service code by eliminating dual code paths and ensures consistent low-latency behavior.

---

## 00596 — feat(agent): add rpc status command and tests; rpc only path
**SHA:** 32720bd372 · **Date:** 2025-12-07 05:20
**Files changed:** src/cli/program.ts, tests/agent-rpc.test.ts
**Tags:** `core-feature`, `testing`

Added status command to RPC protocol that returns {type:"status",ok:true} for health checking. Added unit tests covering RPC send, status, error handling, and malformed request cases. Validates round-trip RPC communication and error propagation.

---

## 00597 — fix(macos): guard unavailable speech recognizer
**SHA:** fb106967bc · **Date:** 2025-12-07 05:22
**Files changed:** apps/macos/Sources/Clawdis/VoiceWakeRuntime.swift
**Tags:** `bugfix`

Added nil check for SFSpeechRecognizer initialization in VoiceWakeRuntime. Prevents crash when requested locale doesn't support speech recognition by logging error and disabling voice wake gracefully.

---

## 00598 — chore(agent): start rpc worker at launch, fail if not running
**SHA:** 2f44046622 · **Date:** 2025-12-07 05:24
**Files changed:** apps/macos/Sources/Clawdis/ClawdisXPCService.swift
**Tags:** `process-lifecycle`, `bugfix`

Modified agentSend to eagerly start RPC worker if not already running and return error if startup fails. Previously would silently fail or hang if worker couldn't spawn; now provides clear error feedback.

---

## 00599 — Settings: add heartbeat controls
**SHA:** bf429b7e87 · **Date:** 2025-12-07 04:30
**Files changed:** apps/macos/Sources/Clawdis/ConfigSettings.swift
**Tags:** `ux`

Added heartbeat configuration UI to Config settings with stepper for interval (0-720 minutes) and text field for message body. Explains that heartbeats keep Pi sessions warm and 0 disables them. Connects to config autosave for persistence.

---

## 00600 — Settings: inline heartbeat inputs
**SHA:** 78d96355dd · **Date:** 2025-12-07 04:32
**Files changed:** apps/macos/Sources/Clawdis/ConfigSettings.swift
**Tags:** `ux`

Adjusted heartbeat controls layout to show stepper and text field inline within LabeledContent instead of separate rows. Maintains 320pt width for message field for visual consistency with other config inputs.

---
