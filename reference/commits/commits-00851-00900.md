# Commit Reference: 00851–00900

A plain factual summary of every commit in the OpenClaw repository, from commit 851 through commit 900.

---

## 00851 — feat(macos): surface session activity in menu bar
**SHA:** 6b10f4241d · **Date:** 2025-12-09 01:28
**Files changed:** AppState.swift, Constants.swift, ControlChannel.swift, CritterStatusLabel.swift, DebugSettings.swift, IconState.swift, MenuBar.swift, MenuContentView.swift, WorkActivityStore.swift, docs/mac/menu-bar.md
**Tags:** `core-feature`, `ux`

Adds real-time agent work tracking to the macOS menu bar. Introduces IconState enum and WorkActivityStore to display session activity (main vs other sessions) with tool-specific glyphs (bash, read, write, edit, attach) and colored badges. The menu status row now shows active job/tool labels (e.g. "Main · bash: pnpm test") when work is running, falling back to health status when idle. Includes debug override picker for testing icon states.

---

## 00852 — chore: harden rpc assistant streaming types
**SHA:** 27a545f79d · **Date:** 2025-12-09 01:31
**Files changed:** webchat.bundle.js (large bundle update with pnpm dependency path changes)
**Tags:** `type-safety`, `dependency`

Updates bundled web chat dependencies with stricter pnpm lockfile paths. All lit-html, lit-element, @lit/reactive-element, and @mariozechner/mini-lit imports now include explicit .pnpm version paths in region markers. This hardens the RPC streaming type structure to match Pi/Tau assistant message types.

---

## 00853 — refactor: type tau rpc stream events
**SHA:** e44ed2681f · **Date:** 2025-12-09 01:37
**Files changed:** command-reply.ts
**Tags:** `type-safety`, `refactor`

Replaces loose RpcStreamEvent type with typed AgentEvent union from @mariozechner/pi-ai. Changes streamAssistantFinal parameter from generic object to AssistantMessage. Improves message role checking with explicit type guards for tool_result/toolResult message handling and conditional property access for toolCallId.

---

## 00854 — fix: stop partial replies for whatsapp/telegram surfaces
**SHA:** 5bfecc6152 · **Date:** 2025-12-09 01:40
**Files changed:** command-reply.test.ts, command-reply.ts
**Tags:** `bugfix`, `provider`

Disables streaming partial replies for WhatsApp/Telegram surfaces while preserving full streaming to internal UIs and control channels. Adds test coverage verifying that onPartialReply callback is excluded when replying to WhatsApp messages. Only final replies are now delivered to external messaging platforms.

---

## 00855 — fix: block partial replies on external chat surfaces
**SHA:** 3fe68a051a · **Date:** 2025-12-09 01:48
**Files changed:** AGENTS.md, auto-reply.test.ts, auto-reply.ts, agent.ts, status.ts
**Tags:** `bugfix`, `provider`, `documentation`

Extends partial reply blocking to all external chat surfaces. Adds system event queuing and provider summary to main session context. Introduces Surface parameter to agent command context and buildProviderSummary helper. Documents the rule in AGENTS.md: never send streaming/partial replies to external messaging surfaces (WhatsApp, Telegram).

---

## 00856 — Voice wake: send or dismiss on release
**SHA:** 317f666d4c · **Date:** 2025-12-09 02:25
**Files changed:** VoicePushToTalk.swift, VoiceWakeOverlay.swift, VoiceWakeRuntime.swift
**Tags:** `core-feature`, `ux`

Changes push-to-talk behavior to send or dismiss immediately on button release. Empty transcripts trigger immediate dismiss; non-empty transcripts present final overlay and call sendNow without auto-send delay. Changes presentFinal autoSendAfter parameter to optional TimeInterval to support this manual-send flow.

---

## 00857 — feat: surface system presence for the agent
**SHA:** 1969e78d54 · **Date:** 2025-12-09 02:25
**Files changed:** command-reply.ts, reply.ts, agent.ts, status.ts, provider-summary.ts, system-events.ts
**Tags:** `core-feature`

Introduces system event queuing and provider presence snapshot for main session context. New drainSystemEvents and enqueueSystemEvent functions manage per-session state. buildProviderSummary constructs concise connection summaries (e.g. Web connected, Telegram active). Main sessions prepend queued system events and provider snapshot to the agent's context on new sessions.

---

## 00858 — feat(macos): add instances tab and presence beacons
**SHA:** bc92f6d4a4 · **Date:** 2025-12-09 02:25
**Files changed:** ControlChannel.swift, InstancesSettings.swift, InstancesStore.swift, SettingsView.swift, system-presence.ts, control-channel.ts
**Tags:** `core-feature`

Adds Instances settings tab to macOS app showing connected Clawdis nodes with presence beacons. InstancesStore polls system-presence RPC endpoint and displays host, IP, version, provider, and last-seen timestamps. ControlChannel.sendSystemEvent sends text to main session via RPC. Backend system-presence module tracks and serves instance metadata.

---

## 00859 — style(macos): remove quit separator and resize settings
**SHA:** 31750b5ee5 · **Date:** 2025-12-09 02:28
**Files changed:** MenuContentView.swift
**Tags:** `ux`

Removes the quit menu separator and resize settings UI from macOS menu bar. Simplifies menu structure by removing Divider before quit button and corresponding resize toggle elements.

---

## 00860 — fix merge; add control logging
**SHA:** e15475449c · **Date:** 2025-12-09 01:45
**Files changed:** ControlChannel.swift
**Tags:** `bugfix`, `verbosity`

Adds logging for control channel responses. Logs successful responses at debug level and errors at error level, surfacing method name, duration, and payload size for debugging RPC communication.

---

## 00861 — Voice wake: drop stale recognition callbacks
**SHA:** 421401ae3f · **Date:** 2025-12-09 02:57
**Files changed:** VoiceWakeRuntime.swift
**Tags:** `bugfix`

Prevents stale speech recognition callbacks from updating UI after session ends. Stores recognizer start epoch and ignores callbacks from earlier epochs, fixing race conditions where old recognition results could overwrite current session state.

---

## 00862 — fix(voicewake): snap overlay to top-right
**SHA:** 912a53318e · **Date:** 2025-12-09 03:18
**Files changed:** VoiceWakeOverlay.swift
**Tags:** `bugfix`, `ux`

Changes voice wake overlay window positioning to top-right corner with 20pt padding. Sets window frame explicitly with x-offset from screen width to ensure consistent placement across displays.

---

## 00863 — Voice wake: log overlay lifecycle and enforce PTT cooldown
**SHA:** 3a42979e53 · **Date:** 2025-12-09 03:20
**Files changed:** VoiceWakeOverlay.swift
**Tags:** `verbosity`, `bugfix`

Adds lifecycle logging for voice overlay present/dismiss events with reasons (empty, cancel, sent, timeout). Enforces PTT cooldown by tracking last-sent timestamp and rejecting sends within 700ms window to prevent accidental double-sends from rapid hotkey presses.

---

## 00864 — Docs: voice overlay plan and fix web mocks
**SHA:** 99a31021348 · **Date:** 2025-12-09 03:25
**Files changed:** docs/voice-overlay-tokenized-session.md, web-provider.test.ts
**Tags:** `documentation`, `testing`

Documents tokenized voice overlay session plan for multi-source coordination. Explains session token system to prevent cross-session interference between always-on wake word and push-to-talk. Fixes web provider test mocks to handle new reply signature.

---

## 00865 — Control: route health/heartbeat over RPC stdio
**SHA:** 04f595cd97 · **Date:** 2025-12-09 02:25
**Files changed:** AgentRPC.swift, ControlChannel.swift, control-channel.ts, health.ts, heartbeat-events.ts
**Tags:** `refactor`, `core-feature`

Routes health check and heartbeat queries through RPC stdio control-request frames. Adds AgentRPC.controlRequest method with pending waiter continuations. ControlChannel now uses request() for health/heartbeat instead of agent-send, improving separation of concerns between agent conversations and system queries.

---

## 00866 — macOS: broaden chime sound catalog
**SHA:** 5a74b40ae4 · **Date:** 2025-12-09 03:27
**Files changed:** VoiceWakeSettings.swift
**Tags:** `ux`

Expands voice wake chime sound catalog from hardcoded list to include all system sounds. Searches ~/Library/Sounds, /Library/Sounds, and /System/Library/Sounds for audio files (aif, aiff, caf, wav, m4a, mp3) and presents sorted picker with "Glass" pinned first.

---

## 00867 — macOS: include mail sounds in chime picker
**SHA:** a8b26570e0 · **Date:** 2025-12-09 03:28
**Files changed:** VoiceWakeSettings.swift
**Tags:** `ux`

Adds Mail.app sounds to chime picker by including /System/Applications/Mail.app/Contents/Resources in search roots. Exposes system notification sounds like "Mail Sent", "New Mail", "Mail Scheduled" as voice wake chime options.

---

## 00868 — Build: fix RPC sendable params and CLI imports
**SHA:** c568284f1b · **Date:** 2025-12-09 03:33
**Files changed:** ControlChannel.swift, RuntimeLocator.swift
**Tags:** `bugfix`, `type-safety`

Fixes Swift 6 Sendable warnings in ControlChannel by making request method public and removing Sendable requirement from params dictionary. Cleans up RuntimeLocator import warnings.

---

## 00869 — RPC: extract stdio loop and tests
**SHA:** 59a2cbefcb · **Date:** 2025-12-09 02:37
**Files changed:** program.ts, loop.ts, loop.test.ts
**Tags:** `refactor`, `testing`

Extracts RPC stdio loop from program.ts into standalone loop.ts module with comprehensive test coverage. Adds tests for status, health, heartbeat, system-event, and system-presence control requests. Verifies event forwarding for heartbeat and agent streams.

---

## 00870 — RPC: fix presence imports
**SHA:** 8d8584849c · **Date:** 2025-12-09 02:39
**Files changed:** loop.ts
**Tags:** `bugfix`

Fixes missing imports for listSystemPresence and updateSystemPresence functions in RPC loop module.

---

## 00871 — macOS: log control responses
**SHA:** 76d559efc1 · **Date:** 2025-12-09 02:41
**Files changed:** ControlChannel.swift
**Tags:** `verbosity`

Adds verbose logging for all control channel responses, including method name, duration, response size, and success/error status to aid debugging.

---

## 00872 — macOS: centralize sound effect catalog/player
**SHA:** dbcb97949f · **Date:** 2025-12-09 03:37
**Files changed:** SoundEffects.swift, VoiceWakeChimePlayer.swift, VoiceWakeSettings.swift
**Tags:** `refactor`

Consolidates sound discovery and playback into SoundEffectCatalog and SoundEffectPlayer. Searches multiple system directories with priority order, caches URL map, and provides unified playback interface with reason logging. Replaces inline NSSound calls with centralized player.

---

## 00873 — VoiceWake: autoplay chime on selection
**SHA:** 514b90ac69 · **Date:** 2025-12-09 03:39
**Files changed:** VoiceWakeSettings.swift
**Tags:** `ux`

Adds immediate preview playback when selecting voice wake chimes in settings. Picker onChange handler calls SoundEffectPlayer.play(reason: "settings.preview") so users hear the sound before saving.

---

## 00874 — Health: clean degraded message; PTT hotkey monitors
**SHA:** 7aefcab8b0 · **Date:** 2025-12-09 03:46
**Files changed:** HealthStore.swift, VoicePushToTalkHotkey.swift
**Tags:** `bugfix`, `verbosity`

Cleans up degraded health message formatting by removing PTT monitor noise from summary text. Reduces VoicePushToTalkHotkey logging verbosity and removes redundant health state strings.

---

## 00875 — mac: stop leaking ssh processes on quit
**SHA:** e7cdac90f5 · **Date:** 2025-12-09 02:50
**Files changed:** AppState.swift, MenuContentView.swift
**Tags:** `bugfix`, `process-lifecycle`

Adds cleanup for SSH tunnel processes on app quit. Calls SSHTunnelManager.stopAll() and VoiceWakeRuntime.shared.stop() in AppState deinit to prevent orphaned SSH connections when quitting macOS app.

---

## 00876 — VoiceWake: route forwarding via agent rpc
**SHA:** af9ccf0c09 · **Date:** 2025-12-09 02:50
**Files changed:** VoiceWakeForwarder.swift, VoicePushToTalk.swift, VoiceWakeOverlay.swift, VoiceWakeRuntime.swift
**Tags:** `refactor`, `core-feature`

Removes SSH-based voice wake forwarding in favor of AgentRPC. Deletes CLI cache, path lookup, and remote shell command generation. VoiceWakeForwarder now only handles transcript prefixing. Actual forwarding goes through AgentRPC.sendAgent for cleaner process management.

---

## 00877 — tests: cover voicewake template defaults
**SHA:** 280c7c851f · **Date:** 2025-12-09 02:52
**Files changed:** templating.test.ts
**Tags:** `testing`

Adds test coverage for voice wake template variable defaults. Verifies that ${text} expands correctly and missing ${prefix} variables don't break template rendering.

---

## 00878 — feat(instances): beacon on connect and relay self-entry
**SHA:** 38c4f4f76c · **Date:** 2025-12-09 03:56
**Files changed:** system-presence.ts, web-provider.ts, telegram-provider.ts, auto-reply.ts
**Tags:** `core-feature`

Sends presence beacon on provider connection with hostname, IP, version, and provider metadata. Relay stores its own entry in system-presence list via updateSystemPresence on successful connection. Ensures /status includes self in instances list.

---

## 00879 — PTT: wait for final transcript before send/dismiss
**SHA:** 3377bd4ae5 · **Date:** 2025-12-09 03:56
**Files changed:** VoicePushToTalk.swift
**Tags:** `bugfix`, `ux`

Increases push-to-talk finalize timeout from 700ms to 1.5s to await speech recognition final result. Prevents premature send/dismiss on button release by giving Speech framework more time to deliver accurate transcript.

---

## 00880 — WebChat: make tunnel restart handler hop to MainActor
**SHA:** 40c8e4832a · **Date:** 2025-12-09 03:58
**Files changed:** SSHTunnelManager.swift
**Tags:** `bugfix`, `type-safety`

Wraps tunnel restart continuation resume in MainActor.run to fix concurrency warnings. Ensures UI updates from tunnel state changes happen on main thread.

---

## 00881 — feat(status): enrich session details
**SHA:** 2177df51a8 · **Date:** 2025-12-09 03:00
**Files changed:** status.ts, sessions.ts
**Tags:** `core-feature`, `ux`

Enriches /status command output with session last-message timestamps, turn counts, and system event queue depth. Adds peekSystemEvents to show pending events without draining. StatusSummary now includes provider summary and queued event count.

---

## 00882 — rpc: ensure worker is killed if it hangs on shutdown
**SHA:** 4eb71bcd14 · **Date:** 2025-12-09 03:04
**Files changed:** AgentRPC.swift
**Tags:** `bugfix`, `process-lifecycle`

Adds 3-second timeout to RPC worker termination. If graceful shutdown via SIGTERM fails, sends SIGKILL after timeout to prevent zombie processes. Logs forced termination with PID for debugging.

---

## 00883 — VoiceWake: drop remote ssh config and harden template parsing
**SHA:** 2756e12762 · **Date:** 2025-12-09 03:04
**Files changed:** VoiceWakeSettings.swift, templating.ts, templating.test.ts
**Tags:** `refactor`, `type-safety`

Removes SSH target/identity/command UI from voice wake settings after migration to AgentRPC. Hardens template parsing to gracefully handle missing variables without throwing, returning original template on parse failure.

---

## 00884 — Overlay: safety dismiss and logging; keep PTT final send
**SHA:** 8e15a6e798 · **Date:** 2025-12-09 04:04
**Files changed:** VoiceWakeOverlay.swift, VoicePushToTalk.swift
**Tags:** `bugfix`, `verbosity`

Adds safety checks to overlay dismiss to prevent crashes when window is nil. Logs all dismiss reasons (empty, cancel, sent, timeout). Preserves PTT immediate send behavior from commit 856 while improving error handling.

---

## 00885 — VoiceWake: drop unused forward health check state
**SHA:** 3dff09424d · **Date:** 2025-12-09 03:12
**Files changed:** VoiceWakeRuntime.swift
**Tags:** `refactor`

Removes unused forwardHealthCheckTask and related state tracking from VoiceWakeRuntime after SSH forwarding removal. Cleans up dead code from pre-AgentRPC forwarding implementation.

---

## 00886 — Relay: enforce single instance lock
**SHA:** 2cd27d0d4a · **Date:** 2025-12-09 03:17
**Files changed:** program.ts, relay-lock.ts, relay-lock.test.ts
**Tags:** `core-feature`, `bugfix`

Adds Unix domain socket-based instance lock to prevent concurrent relay processes. acquireRelayLock creates lock file at ~/.clawdis/relay.sock and throws RelayLockError if already held. Relay command acquires lock on startup and releases on shutdown. Includes test coverage for lock acquisition and cleanup.

---

## 00887 — fix(presence): always seed self entry and log counts
**SHA:** 6b8011228e · **Date:** 2025-12-09 03:21
**Files changed:** system-presence.ts
**Tags:** `bugfix`, `verbosity`

Ensures relay always includes self in presence list by seeding with hostname, IP, and version on module load. Logs presence entry count on every update/list call for debugging. Fixes empty instances list when no external beacons received.

---

## 00888 — chore(instances): log empty payloads and add local fallback
**SHA:** 9dee4c158d · **Date:** 2025-12-09 04:29
**Files changed:** InstancesStore.swift
**Tags:** `verbosity`, `bugfix`

Logs when presence RPC returns empty payload to aid debugging. Adds local fallback showing hostname with "(local)" marker when backend returns no instances. Prevents confusing blank instances tab.

---

## 00889 — fix(rpc): keep stdout json-only
**SHA:** cfd2c41c21 · **Date:** 2025-12-09 04:34
**Files changed:** loop.ts, control-channel.ts
**Tags:** `bugfix`

Removes console.error calls from RPC loop to keep stdout pure JSON. Routes errors through respond({ type: "error" }) instead. Fixes macOS RPC parser breaking on stray stderr output mixed into JSON stream.

---

## 00890 — feat(mac): tokenized voice overlay adoption
**SHA:** d084a37e11 · **Date:** 2025-12-09 04:35
**Files changed:** VoicePushToTalk.swift, VoiceWakeOverlay.swift, VoiceWakeRuntime.swift
**Tags:** `core-feature`, `refactor`

Implements tokenized voice overlay sessions to prevent cross-session interference. Each session (wake word, PTT) gets unique UUID token. PTT can adopt existing overlay text as prefix for continuation. VoiceWakeOverlayController tracks active token and rejects updates from stale sessions. Increases PTT timeout to 1.5s.

---

## 00891 — Docs: clarify relay launch mechanism
**SHA:** b9cc914729 · **Date:** 2025-12-09 03:36
**Files changed:** docs/relay-launch.md
**Tags:** `documentation`

Documents relay launch behavior: macOS app spawns relay subprocess via AgentRPC, relay enforces single-instance lock, and relay survives app quit unless explicitly stopped. Explains socket lock mechanism and process lifecycle.

---

## 00892 — chore(mac): apply swiftformat and lint fixes
**SHA:** 51aed3ca0a · **Date:** 2025-12-09 04:42
**Files changed:** Multiple Swift files across apps/macos/Sources/Clawdis/
**Tags:** `linting`

Applies swiftformat and SwiftLint fixes across macOS codebase. Standardizes whitespace, removes trailing commas, fixes indentation, and resolves minor lint warnings without behavior changes.

---

## 00893 — Overlay: log token drops and immediate auto-send
**SHA:** 49fa093767 · **Date:** 2025-12-09 04:47
**Files changed:** VoiceWakeOverlay.swift
**Tags:** `verbosity`, `bugfix`

Logs when overlay updates are dropped due to token mismatch to debug session interference. Preserves immediate auto-send (0s delay) for wake word sessions to maintain fast response UX.

---

## 00894 — Presence: resilient local fallback
**SHA:** 658e0c6b03 · **Date:** 2025-12-09 04:48
**Files changed:** system-presence.ts
**Tags:** `bugfix`

Hardens presence system to handle missing hostname/IP gracefully. Falls back to "unknown" for hostname and "0.0.0.0" for IP when network info unavailable. Ensures self-entry always exists even if lookups fail.

---

## 00895 — chore(instances): harden presence refresh and fix lint
**SHA:** f0860ec145 · **Date:** 2025-12-09 04:51
**Files changed:** InstancesStore.swift, InstancesSettings.swift
**Tags:** `linting`, `refactor`

Adds error handling for presence refresh failures and applies SwiftLint fixes. Logs decode errors without crashing and shows error message in UI. Removes unused imports.

---

## 00896 — fix(mac): make rpc parsing tolerate stray stdout
**SHA:** b04f04776b · **Date:** 2025-12-09 05:01
**Files changed:** AgentRPC.swift
**Tags:** `bugfix`

Makes RPC line parser skip non-JSON lines instead of crashing. Logs parse failures and continues reading to handle stray debug output. Fixes crashes when relay emits warnings before JSON events.

---

## 00897 — Overlay: block new sessions while sending; delay runtime restart
**SHA:** 1bbb424322 · **Date:** 2025-12-09 05:02
**Files changed:** VoiceWakeOverlay.swift, VoiceWakeRuntime.swift
**Tags:** `bugfix`, `ux`

Blocks new voice wake sessions while overlay is sending to prevent interruption. Delays VoiceWakeRuntime restart by 2 seconds after send to avoid capturing the send command as new input. Sets isSending flag that rejects incoming session starts.

---

## 00898 — Runtime: delay restart inside actor; log RPC unexpected payload
**SHA:** 024a823c78 · **Date:** 2025-12-09 05:02
**Files changed:** VoiceWakeRuntime.swift, AgentRPC.swift
**Tags:** `bugfix`, `verbosity`

Moves runtime restart delay inside actor boundary to fix concurrency warnings. Adds logging for unexpected RPC payload types to diagnose protocol mismatches. Ensures restart delay Task respects actor isolation.

---

## 00899 — Runtime: drop bun support
**SHA:** 39a0f54b0d · **Date:** 2025-12-09 04:13
**Files changed:** README.md, RuntimeLocator.swift, RuntimeResolution.swift, RuntimeResolutionError.swift
**Tags:** `refactor`, `dependency`

Removes Bun runtime support, requiring Node ≥22.0.0. Deletes RuntimeKind.bun case, minBun version check, and bun binary search logic. Simplifies RuntimeLocator to only resolve Node. Updates README to remove Bun from requirements.

---

## 00900 — Update auto-reply and voice wake runtime
**SHA:** 998a5b080d · **Date:** 2025-12-09 04:15
**Files changed:** package.json, pnpm-lock.yaml
**Tags:** `dependency`

Updates auto-reply runtime dependencies in package.json and regenerates pnpm-lock.yaml. Includes voice wake runtime package version bumps for compatibility with token-based overlay sessions.
