# Commit Reference: 01151–01200

A plain factual summary of every commit in the OpenClaw repository, from commit 1151 through commit 1200.

---

## 01151 — test(macos): cover gateway connection reuse
**SHA:** d8cb1daa78 · **Date:** 2025-12-12 21:42:16
**Files changed:** `apps/macos/Tests/ClawdisIPCTests/GatewayChannelConfigureTests.swift`, `apps/macos/Tests/ClawdisIPCTests/GatewayChannelShutdownTests.swift`
**Tags:** `testing`, `core-feature`

Extended gateway channel test coverage to include concurrent request scenarios and connection reuse patterns. Added a new test suite for shutdown scenarios to ensure the connection properly cleans up and prevents reconnect loops when shutting down during receive failures.

---

## 01152 — fix(macos): avoid external open for about:blank
**SHA:** 61085f6141 · **Date:** 2025-12-12 21:56:54
**Files changed:** `apps/macos/Sources/Clawdis/CanvasWindow.swift`
**Tags:** `bugfix`, `ux`

Fixed Canvas panel navigation to keep internal web URLs (about:blank, blob, data, javascript schemes) within the panel instead of sending them to NSWorkspace. Added logic to only open external URLs when a registered handler exists, preventing confusing "no application set" dialogs.

---

## 01153 — fix(mac): timeout ClawdisCLI socket calls
**SHA:** 13b8dc61ba · **Date:** 2025-12-12 21:54:14
**Files changed:** `apps/macos/Sources/ClawdisCLI/main.swift`
**Tags:** `bugfix`, `core-feature`

Added timeout enforcement to direct UNIX socket calls in ClawdisCLI with configurable timeout per request type. Implemented non-blocking socket setup and SO_NOSIGPIPE handling to prevent hangs and handle connection failures gracefully.

---

## 01154 — fix(ios): harden voice wake callbacks
**SHA:** e31383a8f1 · **Date:** 2025-12-12 21:59:04
**Files changed:** `apps/ios/Sources/Voice/VoiceWakeManager.swift`
**Tags:** `bugfix`, `core-feature`

Hardened voice wake recognition callbacks by wrapping them in MainActor context to fix race conditions and actor isolation issues. Updated error handling and recovery logic to ensure proper state management during recognition failures.

---

## 01155 — fix(bridge): use default Bonjour domain
**SHA:** 9cf457be0a · **Date:** 2025-12-12 21:59:04
**Files changed:** `apps/ios/Sources/Bridge/BridgeDiscoveryModel.swift`, `apps/macos/Sources/Clawdis/Bridge/BridgeServer.swift`
**Tags:** `bugfix`, `networking`

Changed Bonjour discovery to use default domain (nil) instead of explicitly specifying the domain, allowing proper mDNS resolution across different network segments. This simplifies configuration and improves automatic service discovery.

---

## 01156 — refactor(macos): replace gateway NotificationCenter with event bus
**SHA:** 6a7f955818 · **Date:** 2025-12-12 22:06:40
**Files changed:** `apps/macos/Sources/Clawdis/ControlChannel.swift`, `apps/macos/Sources/Clawdis/GatewayConnection.swift`
**Tags:** `refactor`, `core-feature`

Replaced NotificationCenter-based event handling in gateway with async Task-based event streaming. This improves thread safety and provides better lifecycle management for event listeners.

---

## 01157 — fix(macos): keep voice wake overlay on top
**SHA:** c50c3699d9 · **Date:** 2025-12-12 22:09:14
**Files changed:** `apps/macos/Sources/Clawdis/VoiceWakeWindow.swift`
**Tags:** `bugfix`, `ux`

Fixed z-order handling for voice wake overlay to ensure it remains on top of other windows. Updated window level configuration to prevent the overlay from being hidden behind Canvas or other application windows.

---

## 01158 — fix(macos): avoid ptt audio teardown race
**SHA:** 6354dddff2 · **Date:** 2025-12-12 22:24:24
**Files changed:** `apps/macos/Sources/Clawdis/PushToTalkAudio.swift`, `apps/macos/Sources/Clawdis/VoiceWakeManager.swift`
**Tags:** `bugfix`, `core-feature`

Fixed race condition during push-to-talk audio teardown by ensuring proper task cancellation and cleanup ordering. Prevents audio engine state corruption when rapidly switching between voice wake and PTT modes.

---

## 01159 — refactor(macos): centralize gateway endpoint resolution
**SHA:** 14e3b34a8e · **Date:** 2025-12-12 22:26:43
**Files changed:** `apps/macos/Sources/Clawdis/GatewayEndpointStore.swift`, `apps/macos/Sources/Clawdis/GatewayConnection.swift`
**Tags:** `refactor`, `core-feature`

Centralized gateway endpoint resolution logic into a dedicated EndpointStore actor to improve maintainability and reduce duplication. This establishes a single source of truth for endpoint configuration and caching.

---

## 01160 — refactor(macos): extract gateway payload decoding
**SHA:** c7bd4b5c1d · **Date:** 2025-12-12 22:26:48
**Files changed:** `apps/macos/Sources/Clawdis/GatewayPayloadDecoder.swift`, `apps/macos/Sources/Clawdis/GatewayChannel.swift`
**Tags:** `refactor`, `core-feature`

Extracted gateway frame and payload decoding logic into a dedicated decoder module. This simplifies the main channel logic and makes protocol-level decoding more testable and maintainable.

---

## 01161 — test(macos): cover gateway endpoint store
**SHA:** cc4f0d8acc · **Date:** 2025-12-12 22:26:53
**Files changed:** `apps/macos/Tests/ClawdisIPCTests/GatewayEndpointStoreTests.swift`
**Tags:** `testing`, `core-feature`

Added comprehensive test coverage for the gateway endpoint store actor, including endpoint caching, expiration, and refresh behavior. Tests verify correct handling of concurrent access patterns.

---

## 01162 — docs: finalize gateway refactor notes
**SHA:** 086f98471e · **Date:** 2025-12-12 22:26:57
**Files changed:** `docs/architecture/gateway-refactor.md`
**Tags:** `documentation`

Added architecture documentation summarizing the gateway refactoring effort, including endpoint resolution centralization, payload decoding extraction, and event bus migration. Provides context for future maintenance and development.

---

## 01163 — fix(mac): make Canvas file watcher reliable
**SHA:** 03c84d0f11 · **Date:** 2025-12-12 22:50:25
**Files changed:** `apps/macos/Sources/Clawdis/CanvasWindow.swift`, `apps/macos/Sources/Clawdis/FileWatcher.swift`
**Tags:** `bugfix`, `core-feature`

Fixed file watcher for Canvas panel to reliably detect file system changes and reload content. Improved error handling and edge case coverage for file monitoring on macOS.

---

## 01164 — test(web): retry session tmp cleanup
**SHA:** 0484aba892 · **Date:** 2025-12-12 22:55:39
**Files changed:** `apps/web/tests/session.test.ts`
**Tags:** `testing`

Added retry logic to session temporary directory cleanup in tests to handle timing issues in CI environments. Improves test reliability by accounting for file system timing variations.

---

## 01165 — fix(mac): recover control tunnel after restart
**SHA:** 952d924581 · **Date:** 2025-12-12 22:45:18
**Files changed:** `apps/macos/Sources/Clawdis/GatewayConnection.swift`, `apps/macos/Sources/Clawdis/ControlTunnel.swift`
**Tags:** `bugfix`, `core-feature`

Fixed control tunnel connection recovery after app restart to properly re-establish connection to the gateway. Improved state tracking to ensure tunnel is reconnected when needed.

---

## 01166 — fix(node): prevent iOS VoiceWake crash
**SHA:** e502ad13f9 · **Date:** 2025-12-12 23:06:17
**Files changed:** `apps/ios/Sources/Voice/VoiceWakeManager.swift`
**Tags:** `bugfix`, `core-feature`

Prevented crashes in iOS VoiceWake system when handling certain edge case callbacks. Added proper nil checks and state validation to avoid accessing deallocated objects.

---

## 01167 — fix(status): account cached prompt tokens
**SHA:** c3aed2543e · **Date:** 2025-12-12 23:22:05
**Files changed:** `apps/macos/Sources/Clawdis/StatusProvider.swift`, `apps/gateway/src/status.rs`
**Tags:** `bugfix`

Fixed status reporting to properly account for cached prompt tokens in context usage calculations. Ensures accurate usage tracking when prompts are cached across sessions.

---

## 01168 — fix(macos): clarify presence update source label
**SHA:** e915ed182d · **Date:** 2025-12-12 23:27:08
**Files changed:** `apps/macos/Sources/Clawdis/PresenceView.swift`
**Tags:** `bugfix`, `ux`

Clarified UI labels for presence update sources to reduce ambiguity about where status updates originate. Improved user experience by making the source of presence information more obvious.

---

## 01169 — feat(gateway): switch handshake to req:connect (protocol v2)
**SHA:** d5d80f4247 · **Date:** 2025-12-12 23:29:57
**Files changed:** `apps/macos/Sources/Clawdis/GatewayChannel.swift`, `apps/gateway/src/handshake.rs`, `apps/ios/Sources/Gateway/GatewayConnection.swift`
**Tags:** `core-feature`, `api`

Switched gateway handshake protocol from hello/hello-ok exchange to the new req:connect request-response pattern. This is a breaking protocol change that simplifies the initial connection sequence and enables more flexible future extensions.

---

## 01170 — feat(mac): show context usage bars
**SHA:** 35b7c0f558 · **Date:** 2025-12-12 23:33:15
**Files changed:** `apps/macos/Sources/Clawdis/StatusBar.swift`, `apps/macos/Sources/Clawdis/ContextUsageBar.swift`
**Tags:** `core-feature`, `ui`

Added visual context usage bars to the macOS status bar menu showing token consumption for input, cache, and output. Provides quick visual feedback on resource usage at a glance.

---

## 01171 — feat(macos): add clawdis://agent deep link
**SHA:** 3b72ed6e1a · **Date:** 2025-12-12 23:22:40
**Files changed:** `apps/macos/Sources/Clawdis/DeepLinkHandler.swift`, `apps/macos/Clawdis.entitlements`
**Tags:** `core-feature`, `api`

Added support for clawdis://agent deep links to allow external applications to trigger agent interactions. Enables cross-application workflows and integration with other tools.

---

## 01172 — fix: expose heartbeat controls and harden mac CLI
**SHA:** 8846ffec64 · **Date:** 2025-12-12 23:33:12
**Files changed:** `apps/macos/Sources/ClawdisCLI/main.swift`, `apps/gateway/src/heartbeat.rs`
**Tags:** `bugfix`, `core-feature`

Exposed heartbeat control options in macOS CLI and improved gateway heartbeat handling. Added configuration options for heartbeat interval and timeout values.

---

## 01173 — fix(mac): show cached context usage
**SHA:** 072ad8d371 · **Date:** 2025-12-12 23:44:49
**Files changed:** `apps/macos/Sources/Clawdis/StatusBar.swift`
**Tags:** `bugfix`, `ui`

Fixed context usage bar rendering to properly display cached token counts in addition to input/output. Improved visual representation to distinguish between fresh and cached usage.

---

## 01174 — fix(mac): render context bar reliably
**SHA:** 9b9fa009d1 · **Date:** 2025-12-13 00:13:33
**Files changed:** `apps/macos/Sources/Clawdis/ContextUsageBar.swift`, `apps/macos/Sources/Clawdis/StatusBar.swift`
**Tags:** `bugfix`, `ui`

Fixed context usage bar rendering to properly update on status changes and handle edge cases. Improved layout and refresh logic to ensure bars render consistently.

---

## 01175 — fix(mac): render context bar as image
**SHA:** 3bb33bdeed · **Date:** 2025-12-13 00:19:29
**Files changed:** `apps/macos/Sources/Clawdis/ContextBarImage.swift`, `apps/macos/Sources/Clawdis/StatusBar.swift`
**Tags:** `bugfix`, `ui`

Changed context bar rendering from NSView to NSImage for better performance and reliability in status bar. Eliminates layout issues and improves rendering consistency.

---

## 01176 — fix(mac): size context bar to menu
**SHA:** 5e51107711 · **Date:** 2025-12-13 00:23:00
**Files changed:** `apps/macos/Sources/Clawdis/ContextBarImage.swift`
**Tags:** `bugfix`, `ui`

Fixed context bar sizing to properly adapt to menu bar dimensions and DPI scaling. Ensures bars scale correctly on Retina displays and different menu bar heights.

---

## 01177 — fix(ios): avoid actor isolation in audio tap
**SHA:** 2b38ddf78d · **Date:** 2025-12-13 00:14:52
**Files changed:** `apps/ios/Sources/Audio/AudioEngine.swift`
**Tags:** `bugfix`, `core-feature`

Fixed actor isolation issues in iOS audio tap implementation that were causing runtime errors. Properly isolated audio tap callbacks to avoid crossing isolation boundaries.

---

## 01178 — fix(ios): avoid MainActor isolation in audio tap
**SHA:** 117b01acbd · **Date:** 2025-12-13 00:26:05
**Files changed:** `apps/ios/Sources/Audio/AudioEngine.swift`
**Tags:** `bugfix`, `core-feature`

Further improved audio tap implementation to avoid unnecessary MainActor context switches. Optimized audio processing pipeline to run on appropriate actor contexts.

---

## 01179 — refactor(ios): remove manual URL controls
**SHA:** 7f4f01009b · **Date:** 2025-12-13 00:31:52
**Files changed:** `apps/ios/Sources/Canvas/CanvasView.swift`, `apps/ios/Sources/Canvas/URLBar.swift`
**Tags:** `refactor`, `ui`

Removed manual URL input controls from iOS Canvas view in favor of web view native controls. Simplifies iOS implementation and improves consistency with native web browsing patterns.

---

## 01180 — feat(mac): compact context sessions in menu
**SHA:** 854f07d735 · **Date:** 2025-12-13 00:39:12
**Files changed:** `apps/macos/Sources/Clawdis/StatusBar.swift`, `apps/macos/Sources/Clawdis/ContextSessionItem.swift`
**Tags:** `core-feature`, `ui`

Added context session compaction in status bar menu to reduce visual clutter when many sessions are active. Groups related sessions and provides expandable details.

---

## 01181 — chore(macos): move Permissions tab after Tools
**SHA:** f9b1a96c89 · **Date:** 2025-12-13 00:47:08
**Files changed:** `apps/macos/Sources/Clawdis/Settings.swift`
**Tags:** `cleanup`, `ui`

Reordered settings tabs to move Permissions after Tools for improved information hierarchy. Makes the settings UI flow more naturally from configuration to permissions.

---

## 01182 — Merge remote-tracking branch 'origin/main'
**SHA:** ca20a2dc06 · **Date:** 2025-12-13 00:48:01
**Files changed:** multiple files from merge
**Tags:** `cleanup`

Merged changes from remote main branch to sync local development with latest changes. Resolved any merge conflicts to maintain codebase consistency.

---

## 01183 — refactor(ios): minimal full-screen canvas
**SHA:** 8cc2dc715c · **Date:** 2025-12-13 00:50:20
**Files changed:** `apps/ios/Sources/Canvas/CanvasView.swift`, `apps/ios/Sources/Canvas/CanvasController.swift`
**Tags:** `refactor`, `ui`

Refactored iOS Canvas implementation to use minimal full-screen mode with cleaner layout. Removed unnecessary UI elements for a more immersive web viewing experience.

---

## 01184 — fix(mac): avoid collapsed context pills in menu
**SHA:** 19ce08b4d0 · **Date:** 2025-12-13 00:50:55
**Files changed:** `apps/macos/Sources/Clawdis/StatusBar.swift`, `apps/macos/Sources/Clawdis/ContextSessionItem.swift`
**Tags:** `bugfix`, `ui`

Fixed context pill layout to prevent unwanted collapsing in menu display. Improved spacing and sizing logic to maintain visual consistency.

---

## 01185 — fix(macos): prevent control socket hangs
**SHA:** f98ab2d037 · **Date:** 2025-12-13 00:51:39
**Files changed:** `apps/macos/Sources/Clawdis/ControlSocket.swift`
**Tags:** `bugfix`, `core-feature`

Fixed control socket implementation to prevent indefinite hangs on communication failures. Added timeouts and proper error handling for socket operations.

---

## 01186 — feat(mac): show session labels under context bars
**SHA:** 387615e99f · **Date:** 2025-12-13 01:10:12
**Files changed:** `apps/macos/Sources/Clawdis/ContextUsageBar.swift`, `apps/macos/Sources/Clawdis/StatusBar.swift`
**Tags:** `core-feature`, `ui`

Added session labels displayed under context usage bars in status bar menu. Helps users identify which context session each usage bar represents.

---

## 01187 — fix(mac): render context sessions card with labels
**SHA:** 84399e62ae · **Date:** 2025-12-13 01:18:42
**Files changed:** `apps/macos/Sources/Clawdis/ContextCard.swift`
**Tags:** `bugfix`, `ui`

Fixed context sessions card layout to properly display session labels alongside usage information. Improved rendering to prevent label overflow and ensure readability.

---

## 01188 — feat(macos): add Allow Canvas toggle to settings
**SHA:** a56daa6c06 · **Date:** 2025-12-13 01:17:46
**Files changed:** `apps/macos/Sources/Clawdis/Settings.swift`, `apps/macos/Sources/Clawdis/Canvas.swift`
**Tags:** `core-feature`, `config`

Added settings toggle to allow users to enable or disable Canvas functionality. Provides option to hide Canvas from interface when not needed.

---

## 01189 — feat(deeplink): forward agent links via bridge
**SHA:** 378e5acd23 · **Date:** 2025-12-13 01:18:48
**Files changed:** `apps/bridge/src/deeplink.rs`, `apps/ios/Sources/Bridge/BridgeServer.swift`
**Tags:** `core-feature`, `api`

Implemented forwarding of clawdis://agent deep links through the bridge to enable agent interactions on remote systems. Enables unified agent access across different network contexts.

---

## 01190 — refactor(swift): rename ClawdisNodeKit to ClawdisKit
**SHA:** ae0c1573fd · **Date:** 2025-12-13 01:33:30
**Files changed:** `apps/ios/Sources/Clawdis.xcodeproj`, `apps/macos/Sources/Clawdis.xcodeproj`, multiple Swift files
**Tags:** `refactor`, `cleanup`

Renamed the shared Swift framework from ClawdisNodeKit to ClawdisKit to better reflect its broader purpose beyond node-specific functionality. Updated all import statements and references across the codebase.

---

## 01191 — fix(macos): harden remote ssh tunnel
**SHA:** ef83a07066 · **Date:** 2025-12-13 01:43:23
**Files changed:** `apps/macos/Sources/Clawdis/RemoteSSHTunnel.swift`
**Tags:** `bugfix`, `security`

Hardened remote SSH tunnel implementation with improved error handling and connection validation. Added checks to ensure tunnel integrity and proper cleanup on failure.

---

## 01192 — feat(ios): add close button and ready canvas
**SHA:** 416c376077 · **Date:** 2025-12-13 01:49:04
**Files changed:** `apps/ios/Sources/Canvas/CanvasView.swift`, `apps/ios/Sources/Canvas/CanvasControls.swift`
**Tags:** `core-feature`, `ui`

Added close button to iOS Canvas and implemented "ready" state to better manage canvas lifecycle. Improves UX by giving users control over canvas visibility.

---

## 01193 — feat(bridge): show node ip in pairing
**SHA:** 7ef83311bb · **Date:** 2025-12-13 01:57:40
**Files changed:** `apps/bridge/src/pairing.rs`, `apps/ios/Sources/Bridge/PairingUI.swift`
**Tags:** `core-feature`, `ui`

Added display of node IP address in bridge pairing flow to help users identify which node they're connecting to. Improves pairing UX when multiple nodes are available.

---

## 01194 — ui(ios): clean up connected bridge list
**SHA:** 73ccbedcdb · **Date:** 2025-12-13 02:02:38
**Files changed:** `apps/ios/Sources/Bridge/BridgeList.swift`
**Tags:** `ui`, `cleanup`

Cleaned up iOS connected bridge list UI to remove clutter and improve visual hierarchy. Simplified display while maintaining necessary information for user context.

---

## 01195 — docs(agents): forbid git stash without consent
**SHA:** 952810f76c · **Date:** 2025-12-13 02:08:08
**Files changed:** `docs/agents/safety.md`
**Tags:** `documentation`

Added documentation clarifying that agent code modifications should not use git stash without explicit user consent. Establishes guidelines for safe agent-driven repository operations.

---

## 01196 — fix(ios): make canvas full-bleed
**SHA:** f84895f1f1 · **Date:** 2025-12-13 02:14:39
**Files changed:** `apps/ios/Sources/Canvas/CanvasWindow.swift`
**Tags:** `bugfix`, `ui`

Fixed iOS Canvas to use full-bleed layout extending to screen edges. Removes unnecessary margins and padding for more immersive web viewing experience.

---

## 01197 — ui(ios): glassy settings button
**SHA:** 594315d90b · **Date:** 2025-12-13 02:19:34
**Files changed:** `apps/ios/Sources/Canvas/CanvasControls.swift`
**Tags:** `ui`, `cleanup`

Updated iOS settings button styling to use modern glassmorphism design pattern. Improves visual consistency with current iOS design trends.

---

## 01198 — feat(mac): compact context session rows
**SHA:** f466f1bf46 · **Date:** 2025-12-13 02:15:28
**Files changed:** `apps/macos/Sources/Clawdis/ContextCard.swift`, `apps/macos/Sources/Clawdis/StatusBar.swift`
**Tags:** `core-feature`, `ui`

Added compact row layout for context sessions in status bar menu to display more sessions in limited space. Improves menu density without sacrificing readability.

---

## 01199 — feat(mac): tighten context session row
**SHA:** 572d17f46b · **Date:** 2025-12-13 02:30:31
**Files changed:** `apps/macos/Sources/Clawdis/ContextCard.swift`
**Tags:** `core-feature`, `ui`

Further tightened spacing in context session rows to optimize menu space usage. Adjusted padding and margins for more compact visual presentation.

---

## 01200 — Cron: add scheduler, wakeups, and run history
**SHA:** f9409cbe43 · **Date:** 2025-12-13 02:34:11
**Files changed:** `apps/gateway/src/cron/mod.rs`, `apps/gateway/src/cron/scheduler.rs`, `apps/macos/Sources/Clawdis/CronSettings.swift`, `apps/macos/Sources/Clawdis/CronHistory.swift`
**Tags:** `core-feature`, `process-lifecycle`

Added comprehensive Cron scheduler system with periodic task support, wake-up triggers, and execution history tracking. Enables scheduled agent invocations and automated background operations.

---
