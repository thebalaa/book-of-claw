# Commit Reference: 00201–00250

A plain factual summary of every commit in the OpenClaw repository, from commit 201 through commit 250.

---

## 00201 — feat: send session prompt once
**SHA:** 2e3b8a03aa · **Time:** 23:52
**Files changed:** CHANGELOG.md, README.md, docs/claude-config.md, src/auto-reply/reply.ts, src/config/config.ts, src/config/sessions.ts, src/index.core.test.ts
**Tags:** `core-feature`, `process-lifecycle`, `type-safety`

Adds `sendSystemOnce` configuration to avoid re-sending long system prompts on every turn of a session. Introduces `sessionIntro` for optional first-message text. Session storage now tracks a `systemSent` flag and the reply builder conditionally includes bodyPrefix and template only on the first turn when this flag is enabled.

## 00202 — test: cover sendSystemOnce default
**SHA:** 5b83d30887 · **Time:** 23:57
**Files changed:** src/index.core.test.ts
**Tags:** `testing`

Adds test coverage for the default behavior when `sendSystemOnce` is disabled; confirms that system prompt and bodyPrefix are sent on every turn (the backwards-compatible behavior).

## 00203 — feat: keep typing indicators alive during commands
**SHA:** d871dad85f · **Time:** 00:05
**Files changed:** CHANGELOG.md, README.md, src/auto-reply/reply.ts
**Tags:** `core-feature`, `ux`, `verbosity`

Introduces `typingIntervalSeconds` configuration to refresh typing indicators periodically (default 30s) while long-running commands execute. Helps keep the WhatsApp "composing" state visible during extended Claude runs by calling `onReplyStart` at intervals.

## 00204 — docs/tests: typing interval docs and coverage
**SHA:** af8af4881b · **Time:** 00:10
**Files changed:** docs/claude-config.md, src/index.core.test.ts
**Tags:** `testing`, `documentation`

Documents the typing interval feature and adds comprehensive test coverage using real setTimeout behavior instead of fake timers to verify that typing indicators refresh on schedule.

## 00205 — chore: bump version to 1.1.0
**SHA:** e107f115e2 · **Time:** 00:11
**Files changed:** package.json
**Tags:** `dependency`

Increments package version from 1.0.4 to 1.1.0 to reflect the session and typing indicator feature additions.

## 00206 — style: normalize indentation to 2 spaces
**SHA:** 8a01dc7f4c · **Time:** 00:15
**Files changed:** src/config/config.ts
**Tags:** `linting`

Converts mixed indentation in configuration type definitions from tabs and varied spacing to consistent 2-space indentation.

## 00207 — chore: format + lint
**SHA:** a67f4db5e2 · **Time:** 00:30
**Files changed:** src/config/config.ts
**Tags:** `linting`

Applies linting and formatting fixes; reverses some indentation changes to use tabs in configuration (per project preference).

## 00208 — chore: format to 2-space and bump changelog
**SHA:** e5f677803f · **Time:** 00:53
**Files changed:** CHANGELOG.md, biome.json, src/auto-reply/claude.test.ts
**Tags:** `linting`, `documentation`

Reformats source files to 2-space indentation, updates biome configuration to enforce space-based indentation, and records pending changes in changelog.

## 00209 — refactor(web): split provider module
**SHA:** 4dd2f3b7f7 · **Time:** 01:16
**Files changed:** src/provider-web.ts, src/web/*.ts (new: session.ts, login.ts, outbound.ts, inbound.ts, auto-reply.ts, media.ts), src/auto-reply/reply.ts
**Tags:** `refactor`

Major refactor splitting the 900+ line provider-web.ts monolith into focused modules under src/web/: session management, login flow, outbound sends, inbound parsing, auto-reply orchestration, and media helpers. Barrel export at provider-web.ts maintains public API compatibility.

## 00210 — test(web): split provider web suite
**SHA:** e0b28b6718 · **Time:** 01:23
**Files changed:** src/web/auto-reply.test.ts (renamed from src/provider-web.test.ts), src/web/login.test.ts
**Tags:** `testing`, `refactor`

Reorganizes web provider tests to match the new module structure; auto-reply tests move to src/web/auto-reply.test.ts and login tests to src/web/login.test.ts.

## 00211 — chore(tests): organize web test imports
**SHA:** b029ab933e · **Time:** 01:24
**Files changed:** src/web/auto-reply.test.ts, src/web/login.test.ts
**Tags:** `linting`

Reorders import statements in web test files to follow a consistent pattern: local logging/subject imports first, then test helpers and mocks.

## 00212 — Auto-reply: refresh typing indicator every 8s
**SHA:** 1fd44857164 · **Time:** 01:27
**Files changed:** README.md, docs/claude-config.md, src/auto-reply/reply.ts
**Tags:** `ux`, `documentation`

Lowers the default typing interval from 30 seconds to 8 seconds for more responsive "composing" state updates in WhatsApp during Claude runs. Updates documentation accordingly.

## 00213 — feat(web): add logout command and tests
**SHA:** a2586b8b06 · **Time:** 01:29
**Files changed:** src/cli/program.ts, src/provider-web.ts, src/web/login.test.ts
**Tags:** `core-feature`, `ux`

Adds `warelay logout` CLI command that clears cached WhatsApp Web credentials from ~/.warelay/credentials. Implemented via new `logoutWeb` function exported from the web provider module; includes basic tests for logout flow.

## 00214 — refactor(auto-reply): split reply helpers
**SHA:** 5c8ce41e12 · **Time:** 02:03
**Files changed:** src/auto-reply/command-reply.ts (new file), src/auto-reply/command-reply.test.ts, src/auto-reply/reply.ts
**Tags:** `refactor`

Extracts command execution logic from reply.ts into a dedicated command-reply.ts module. Handles command argv templating, Claude output parsing, media extraction, and metadata summarization. reply.ts remains the entry point but now orchestrates command-reply for mode=command.

## 00215 — test(auto-reply): add helper coverage and docs
**SHA:** ce5b02a9ad · **Time:** 02:09
**Files changed:** src/auto-reply/command-reply.test.ts, docs/refactor/command-split.md
**Tags:** `testing`, `documentation`

Adds comprehensive tests for the new command-reply module including Claude metadata parsing, cost summaries, and turn counts. Adds refactor documentation explaining the split rationale and usage patterns.

## 00216 — chore(auto-reply): include cwd in timeout message
**SHA:** 4a8bb56a1e · **Time:** 02:18
**Files changed:** src/auto-reply/command-reply.ts, src/auto-reply/command-reply.test.ts
**Tags:** `ux`

Improves timeout error messages to include the working directory (cwd), helping users debug command failures in multi-directory setups. Adds test coverage for the updated error message format.

## 00217 — docs: note auto-reply helper split
**SHA:** 0145f3a585 · **Time:** 02:18
**Files changed:** CHANGELOG.md
**Tags:** `documentation`

Documents the auto-reply module split in the changelog as an internal refactor affecting maintainability but not user-facing behavior.

## 00218 — chore: drop refactor note
**SHA:** ef1222ff31 · **Time:** 02:18
**Files changed:** CHANGELOG.md
**Tags:** `documentation`

Removes a pending refactor note from changelog to keep user-facing documentation clean.

## 00219 — docs: trim changelog to user-facing auto-reply changes
**SHA:** 8682352edb · **Time:** 02:19
**Files changed:** CHANGELOG.md
**Tags:** `documentation`

Trims changelog to focus on user-visible auto-reply improvements (typing intervals, sendSystemOnce) rather than internal refactoring details.

## 00220 — chore: commit pending cli/web test tweaks
**SHA:** e482e7768b · **Time:** 02:19
**Files changed:** src/cli/program.ts, src/web/*.test.ts
**Tags:** `testing`

Commits pending test adjustments and minor CLI changes accumulated during the web provider refactor.

## 00221 — web: add heartbeat and bounded reconnect tuning
**SHA:** baf20af17f · **Time:** 02:34
**Files changed:** docs/refactor/web-provider-split.md (new), src/provider-web.ts, src/web/auto-reply.ts, src/cli/program.ts, src/config/config.ts
**Tags:** `core-feature`, `verbosity`

Introduces periodic heartbeat messages (default every 60s) that the web relay emits to confirm connectivity; adds bounded exponential backoff for reconnection (2s→30s, max 12 attempts) instead of unlimited retries. New CLI options: `--web-heartbeat`, `--web-retries`, `--web-retry-initial`, `--web-retry-max`. Config schema now includes `web.reconnect` and `web.heartbeatSeconds` tuning.

## 00222 — web: extract reconnect helpers and add tests
**SHA:** 765d67cd18 · **Time:** 02:39
**Files changed:** src/web/auto-reply.ts, src/web/auto-reply.test.ts
**Tags:** `refactor`, `testing`

Extracts reconnection backoff logic into dedicated helper functions for clarity and testability. Adds test coverage for bounded exponential backoff behavior and reconnect scenarios.

## 00223 — web: add reconnect logging + troubleshooting doc
**SHA:** 5992e629c3 · **Time:** 02:41
**Files changed:** src/web/auto-reply.ts, docs/troubleshoot-web-relay.md (new)
**Tags:** `documentation`, `verbosity`

Adds detailed logging for reconnect events including backoff amounts, attempt counts, and error reasons. Includes new troubleshooting guide explaining how to interpret reconnect logs and recover from network outages.

## 00224 — chore: update changelog and surface web relay settings
**SHA:** 5c66e8273b · **Time:** 02:43
**Files changed:** CHANGELOG.md, src/cli/program.ts
**Tags:** `documentation`

Updates changelog with heartbeat and reconnect features; surfaces web relay tuning knobs in CLI help text so users discover the new options.

## 00225 — docs: finalize web refactor and coverage
**SHA:** a48420d85f · **Time:** 02:54
**Files changed:** docs/refactor/web-provider-split.md, README.md
**Tags:** `documentation`

Finalizes web provider refactor documentation with clear module boundaries, usage instructions, and no-fallback behavior notes. Updates main README to reference the new logout command and web provider features.

## 00226 — test(auto-reply): cover cwd timeout hint and queue meta
**SHA:** c194247dab · **Time:** 03:03
**Files changed:** src/index.core.test.ts, src/auto-reply/command-reply.test.ts
**Tags:** `testing`

Adds test coverage for cwd inclusion in timeout messages and command queue metadata tracking to ensure operation introspection works end-to-end.

## 00227 — docs: open 1.1.x unreleased section
**SHA:** c9e2d69bfb · **Time:** 03:33
**Files changed:** CHANGELOG.md
**Tags:** `documentation`

Opens a new "1.1.x unreleased" section in changelog to track post-1.1.0 features and changes.

## 00228 — feat: add heartbeat cli and relay trigger
**SHA:** 271004bf60 · **Time:** 17:04
**Files changed:** src/auto-reply/claude.ts, src/cli/program.ts, src/provider-web.ts
**Tags:** `core-feature`, `process-lifecycle`

Adds `warelay heartbeat` CLI command to manually trigger a single heartbeat poll (web provider only). Command detects the destination from allowFrom[0] or --to override. Also adds `--heartbeat-now` flag to relay to run an immediate heartbeat on startup. Updates Claude identity prefix to recognize heartbeat polls and respond with "HEARTBEAT_OK" when no alerts exist.

## 00229 — docs: document heartbeat triggers
**SHA:** 3998933b30 · **Time:** 17:05
**Files changed:** CHANGELOG.md, docs/claude-config.md
**Tags:** `documentation`

Documents the new heartbeat command and relay trigger option, including examples for manual heartbeat invocations and integration with monitoring systems.

## 00230 — fix: heartbeat falls back to last session contact
**SHA:** 0d5e5f8dee · **Time:** 17:08
**Files changed:** src/web/auto-reply.ts
**Tags:** `bugfix`, `process-lifecycle`

Hardens heartbeat targeting to fall back to the most recent contact timestamp if no allowFrom addresses exist, ensuring heartbeats can still reach the user in edge cases.

## 00231 — chore: log heartbeat fallback and add test
**SHA:** 507ed25289 · **Time:** 17:12
**Files changed:** src/web/auto-reply.ts, src/web/auto-reply.test.ts
**Tags:** `testing`, `verbosity`

Adds logging when heartbeat falls back to last session contact and includes test coverage for the fallback behavior.

## 00232 — chore: log heartbeat session snapshot
**SHA:** 37497974345 · **Time:** 17:20
**Files changed:** src/web/auto-reply.ts
**Tags:** `verbosity`

Enhances heartbeat logging to emit a snapshot of the session state (contact info, message counts) at the start of each heartbeat cycle for better observability.

## 00233 — chore: add verbose heartbeat session logging
**SHA:** e6c78df975 · **Time:** 17:21
**Files changed:** src/web/auto-reply.ts, src/web/auto-reply.test.ts
**Tags:** `verbosity`

Extends heartbeat logging in verbose mode to include detailed session metadata (auth age, last update timestamp) to aid in debugging stale sessions.

## 00234 — feat: add heartbeat idle override and preserve session freshness
**SHA:** 135d930c99 · **Time:** 17:26
**Files changed:** src/web/auto-reply.ts, src/cli/program.ts, src/config/config.ts
**Tags:** `core-feature`, `process-lifecycle`

Introduces `--heartbeat-skip-idle` flag and config option to allow heartbeats to skip when session is idle (no new messages since last heartbeat). Also ensures heartbeats preserve session freshness by updating the session timestamp on every heartbeat, preventing timeout-driven session resets during extended monitoring periods.

## 00235 — test: cover heartbeat skip preserving session timestamp
**SHA:** 98d52edcc9 · **Time:** 17:29
**Files changed:** src/web/auto-reply.test.ts
**Tags:** `testing`

Adds test coverage confirming that heartbeats skip when idle and that successful heartbeats update the session timestamp to keep sessions alive.

## 00236 — docs: document heartbeat idle override and tests
**SHA:** 117161e6ff · **Time:** 17:31
**Files changed:** docs/claude-config.md, CHANGELOG.md
**Tags:** `documentation`, `testing`

Documents the new heartbeat idle override configuration and its interaction with session expiry logic. Updates changelog with the feature.

## 00237 — Heartbeat: add relay helper and fix CLI tests
**SHA:** deded848ee · **Time:** 17:49
**Files changed:** src/cli/program.ts, src/provider-web.ts, src/cli/program.test.ts
**Tags:** `refactor`, `testing`

Extracts heartbeat relay logic into a dedicated `runWebHeartbeatOnce` helper function. Fixes CLI tests to properly mock the heartbeat command; ensures relay target resolution works correctly.

## 00238 — CLI: rename heartbeat tmux helper and log file path
**SHA:** 7e5b3958cc · **Time:** 18:00
**Files changed:** src/cli/program.ts, src/cli/tmux-relay.ts
**Tags:** `ux`, `refactor`

Renames the relay tmux helper from relay-tmux to something more descriptive. Improves logging to show the actual tmux session file path so users can locate logs if needed.

## 00239 — fix: add @lid format support and allowFrom wildcard handling
**SHA:** b825f141f3 · **Time:** 12:43
**Files changed:** src/utils.ts, src/index.core.test.ts
**Tags:** `bugfix`, `type-safety`

Adds support for WhatsApp Linked ID (@lid) format in jidToE164() using existing lid-mapping JSON files. Fixes allowFrom wildcard ('*') to actually permit all senders as documented. Maintains backward compatibility with @s.whatsapp.net format. Fixes silent message drops for newer WhatsApp client versions.

## 00240 — Heartbeat: harden targeting and support lid mapping
**SHA:** c20a266a11 · **Time:** 18:15
**Files changed:** src/web/auto-reply.ts, src/cli/program.ts
**Tags:** `bugfix`, `process-lifecycle`

Hardens heartbeat targeting to use the new jidToE164() function supporting @lid format. Updates heartbeat command to properly resolve WhatsApp user IDs regardless of format. Adds validation to reject wildcard allowFrom in heartbeat (heartbeats need explicit targets).

## 00241 — Docs: show --all heartbeat example
**SHA:** ebce6ef26 · **Time:** 18:17
**Files changed:** docs/claude-config.md
**Tags:** `documentation`

Adds example showing how to use heartbeat with `--all` flag to target all allowFrom addresses in a single poll.

## 00242 — Changelog: bump to 1.2.0 unreleased
**SHA:** 8f6e43fd66 · **Time:** 18:18
**Files changed:** CHANGELOG.md
**Tags:** `documentation`

Increments unreleased version to 1.2.0 to reflect heartbeat feature set.

## 00243 — Heartbeat: session-id override and safer fallback
**SHA:** aa6637b47a · **Time:** 18:19
**Files changed:** src/web/auto-reply.ts, src/cli/program.ts
**Tags:** `core-feature`, `process-lifecycle`

Adds `--session-id` option to heartbeat command allowing manual session selection. Implements safer fallback logic that prefers the explicit session-id argument, then falls back to the first allowFrom contact, then to last session contact. Improves target resolution robustness.

## 00244 — Fix heartbeat CLI import for recipients resolution
**SHA:** 73456a68d7 · **Time:** 18:22
**Files changed:** src/cli/program.ts
**Tags:** `bugfix`

Corrects imports in the heartbeat CLI command to properly resolve recipient addresses from configuration, fixing a reference error when running heartbeat without explicit --to argument.

## 00245 — Heartbeat: allow session-id override (with test)
**SHA:** 63bf4683c5 · **Time:** 18:28
**Files changed:** src/cli/program.ts, src/web/auto-reply.ts, src/cli/program.test.ts
**Tags:** `testing`, `core-feature`

Implements session-id override in heartbeat by passing it through the relay parameter. Adds test coverage ensuring the override takes precedence in session resolution.

## 00246 — Heartbeat: honor session override
**SHA:** 26b087c1b4 · **Time:** 18:32
**Files changed:** src/web/auto-reply.ts, src/provider-web.ts
**Tags:** `bugfix`, `process-lifecycle`

Ensures the heartbeat relay function properly respects the session-id override throughout the message send flow, preventing fallback behavior from overriding user-supplied session IDs.

## 00247 — Heartbeat: shorten prompt to token
**SHA:** f869cd4b79 · **Time:** 02:48
**Files changed:** src/auto-reply/claude.ts, src/cli/program.ts, docs/claude-config.md
**Tags:** `ux`, `documentation`

Shortens the Claude identity prefix for heartbeat polls from a long prompt to a single "token" marker to minimize prompt consumption when heartbeats don't require Claude's extended reasoning. Updates documentation to explain the heartbeat prompt convention.

## 00248 — Heartbeat: add ultrathink marker
**SHA:** 8d995a8529 · **Time:** 03:15
**Files changed:** src/auto-reply/claude.ts
**Tags:** `core-feature`

Adds a marker in the Claude identity prefix that identifies heartbeat payloads to the Claude API's extended thinking (ultrathink) model, allowing it to recognize when a prompt is a no-op monitoring ping.

## 00249 — Claude prompt: only prepend on first turn
**SHA:** 9e6ad97cfb · **Time:** 03:53
**Files changed:** src/auto-reply/claude.ts
**Tags:** `refactor`

Refines the Claude identity prefix prepending logic to only include it on the first turn of a session (via sendSystemOnce), avoiding repeated identity statements in multi-turn conversations while preserving the heartbeat marker behavior.

## 00250 — Tests: cover identity prefix gating
**SHA:** 93a103dde5 · **Time:** 04:40
**Files changed:** src/index.core.test.ts, src/auto-reply/claude.test.ts
**Tags:** `testing`

Adds comprehensive test coverage verifying that the Claude identity prefix is only prepended on the first turn when sendSystemOnce is enabled, and includes tests for heartbeat marker recognition across different message types.
